<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OEE KEMAS SEKUNDER System</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Trebuchet MS', sans-serif;
      background: linear-gradient(135deg, #fef3f8 0%, #fce7f3 50%, #f5e6f0 100%);
      color: #4a3f47;
      min-height: 100%;
    }

    * {
      box-sizing: border-box;
    }

    html, body, #app {
      height: 100%;
      width: 100%;
    }

    #app {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #ec4899 0%, #d946a6 50%, #be185d 100%);
      color: white;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(236, 72, 153, 0.2);
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .header-content {
      flex: 1;
      text-align: center;
      min-width: 150px;
    }

    .header h1 {
      margin: 0;
      font-size: clamp(18px, 5vw, 28px);
      font-weight: 700;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .header p {
      margin: 4px 0 0 0;
      font-size: clamp(10px, 2vw, 12px);
      opacity: 0.95;
      letter-spacing: 0.5px;
    }

    .header-datetime {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: clamp(10px, 2vw, 13px);
      font-weight: 600;
      text-align: right;
      white-space: nowrap;
    }

    .header-datetime-time {
      font-size: clamp(12px, 3vw, 16px);
      font-weight: 700;
      font-family: 'Courier New', monospace;
    }

    .mode-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: clamp(11px, 2vw, 13px);
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .mode-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* Dark Mode */
    body.dark-mode {
      background: linear-gradient(135deg, #1f1729 0%, #2d1f35 50%, #3d2640 100%);
      color: #e5e5e5;
    }

    body.dark-mode .tabs-container {
      background: rgba(50, 40, 60, 0.8);
      border-bottom-color: rgba(236, 72, 153, 0.2);
    }

    body.dark-mode .tab-btn {
      color: #9ca3af;
    }

    body.dark-mode .tab-btn:hover,
    body.dark-mode .tab-btn.active {
      color: #f472b6;
    }

    body.dark-mode .content {
      background: transparent;
    }

    body.dark-mode .form-section {
      background: #2d2236;
      border-color: rgba(236, 72, 153, 0.15);
      color: #e5e5e5;
    }

    body.dark-mode .form-group label {
      color: #b9a2b3;
    }

    body.dark-mode .form-group input,
    body.dark-mode .form-group select,
    body.dark-mode .form-group textarea,
    body.dark-mode .input-field {
      background: #1f1729;
      color: #e5e5e5;
      border-color: #403050;
    }

    body.dark-mode .form-group input:focus,
    body.dark-mode .form-group select:focus,
    body.dark-mode .form-group textarea:focus,
    body.dark-mode .input-field:focus {
      background: #2d2236;
      border-color: #ec4899;
    }

    body.dark-mode .card {
      background: #2d2236;
      border-color: rgba(236, 72, 153, 0.15);
      color: #e5e5e5;
    }

    body.dark-mode .score-card {
      background: #2d2236;
      border-color: rgba(236, 72, 153, 0.15);
    }

    body.dark-mode .score-card.high {
      background: #1a3a2a;
      border-color: #10b981;
    }

    body.dark-mode .score-card.low {
      background: #3a1a1a;
      border-color: #ef4444;
    }

    body.dark-mode .score-label {
      color: #b9a2b3;
    }

    body.dark-mode .chart-container {
      background: #2d2236;
      border-color: rgba(236, 72, 153, 0.15);
    }

    body.dark-mode thead {
      background: rgba(60, 40, 60, 0.8);
    }

    body.dark-mode thead th {
      color: #f472b6;
      border-bottom-color: rgba(236, 72, 153, 0.2);
    }

    body.dark-mode tbody td {
      color: #e5e5e5;
      border-bottom-color: rgba(236, 72, 153, 0.1);
    }

    body.dark-mode tbody tr:hover {
      background: rgba(236, 72, 153, 0.08);
    }

    body.dark-mode .master-card {
      background: #2d2236;
      border-color: rgba(236, 72, 153, 0.15);
    }

    body.dark-mode .master-card-name {
      color: #f472b6;
    }

    body.dark-mode .master-card-detail {
      color: #9ca3af;
    }

    body.dark-mode #modal {
      background: #2d2236;
      color: #e5e5e5;
    }

    body.dark-mode #modal-title {
      color: #f472b6;
    }

    body.dark-mode #modal-fields .form-group label {
      color: #b9a2b3;
    }

    body.dark-mode #modal-fields .input-field {
      background: #1f1729;
      color: #e5e5e5;
      border-color: #403050;
    }

    body.dark-mode #modal-fields .input-field:focus {
      background: #2d2236;
      border-color: #ec4899;
    }

    body.dark-mode .section-title {
      color: #f472b6;
    }

    body.dark-mode .chart-title {
      color: #f472b6;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: clamp(11px, 2vw, 13px);
    }

    thead {
      background: rgba(236, 72, 153, 0.08);
    }

    thead th {
      padding: 12px 8px;
      text-align: left;
      font-weight: 700;
      color: #ec4899;
      border-bottom: 2px solid rgba(236, 72, 153, 0.2);
      white-space: nowrap;
    }

    tbody td {
      padding: 10px 8px;
      color: #4a3f47;
      border-bottom: 1px solid rgba(236, 72, 153, 0.1);
      word-break: break-word;
    }

    tbody tr:hover {
      background: rgba(236, 72, 153, 0.05);
    }

    @media (max-width: 768px) {
      table {
        font-size: 11px;
      }
      
      thead th {
        padding: 10px 6px;
      }
      
      tbody td {
        padding: 8px 6px;
      }
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 8px;
      margin-top: 16px;
    }

    body.dark-mode .empty-state {
      color: #6b4c5c;
    }

    .tabs-container {
      display: flex;
      gap: 0;
      background: rgba(255, 255, 255, 0.5);
      border-bottom: 2px solid rgba(236, 72, 153, 0.1);
      padding: 0 12px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab-btn {
      background: none;
      border: none;
      color: #9ca3af;
      padding: 12px 12px;
      cursor: pointer;
      font-size: clamp(10px, 2vw, 13px);
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      white-space: nowrap;
      text-transform: uppercase;
    }

    .tab-btn:hover {
      color: #ec4899;
    }

    .tab-btn.active {
      color: #ec4899;
      border-bottom-color: #ec4899;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    @media (min-width: 768px) {
      .content {
        padding: 24px;
      }
      .tabs-container {
        padding: 0 24px;
      }
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .form-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 16px rgba(236, 72, 153, 0.08);
      border: 1px solid rgba(236, 72, 153, 0.1);
    }

    @media (min-width: 768px) {
      .form-section {
        padding: 24px;
        border-radius: 16px;
      }
    }

    .section-title {
      font-size: clamp(13px, 3vw, 16px);
      font-weight: 700;
      color: #ec4899;
      margin: 0 0 16px 0;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::before {
      content: '';
      width: 3px;
      height: clamp(16px, 4vw, 20px);
      background: linear-gradient(180deg, #ec4899 0%, #d946a6 100%);
      border-radius: 2px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    @media (min-width: 768px) {
      .form-row {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: clamp(10px, 2vw, 12px);
      font-weight: 600;
      color: #6b4c5c;
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border: 2px solid #f3e8f0;
      border-radius: 8px;
      font-size: clamp(12px, 2vw, 14px);
      font-family: inherit;
      transition: all 0.3s ease;
      background: #faf9fb;
      color: #4a3f47;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #ec4899;
      background: white;
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: clamp(11px, 2vw, 13px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: clamp(10px, 1.5vw, 12px);
    }

    .score-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      .score-cards {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
    }

    .score-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(236, 72, 153, 0.08);
      border: 1px solid rgba(236, 72, 153, 0.1);
      transition: transform 0.3s ease;
    }

    @media (min-width: 768px) {
      .score-card {
        padding: 24px;
        border-radius: 14px;
      }
    }

    .score-card:hover {
      transform: translateY(-4px);
    }

    .score-card.high {
      background: linear-gradient(135deg, #f0fdf4 0%, #f0fdf4 100%);
      border-color: #10b981;
    }

    .score-card.low {
      background: linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%);
      border-color: #ef4444;
    }

    .score-label {
      font-size: clamp(10px, 2vw, 12px);
      color: #6b4c5c;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .score-value {
      font-size: clamp(20px, 5vw, 32px);
      font-weight: 700;
      background: linear-gradient(135deg, #ec4899 0%, #d946a6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 16px rgba(236, 72, 153, 0.08);
      border: 1px solid rgba(236, 72, 153, 0.1);
    }

    @media (min-width: 768px) {
      .chart-container {
        padding: 24px;
        border-radius: 14px;
        margin-bottom: 24px;
      }
    }

    .chart-title {
      font-size: clamp(12px, 3vw, 14px);
      font-weight: 700;
      color: #d946a6;
      margin-bottom: 16px;
    }

    @media (min-width: 768px) {
      .chart-title {
        margin-bottom: 20px;
      }
    }

    canvas {
      max-height: 250px;
    }

    @media (min-width: 768px) {
      canvas {
        max-height: 300px;
      }
    }

    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      background: white;
      color: #4a3f47;
      padding: 16px 24px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      font-size: 13px;
      font-weight: 600;
      animation: slideIn 0.3s ease;
      pointer-events: auto;
      border-left: 4px solid #ec4899;
    }

    .toast.success {
      border-left-color: #10b981;
      background: linear-gradient(135deg, #f0fdf4 0%, #f9fce8 100%);
    }

    .toast.error {
      border-left-color: #ef4444;
      background: linear-gradient(135deg, #fef2f2 0%, #fff5f5 100%);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .input-field {
      padding: 8px 10px;
      border: 2px solid #f3e8f0;
      border-radius: 6px;
      font-size: clamp(11px, 2vw, 12px);
      font-family: inherit;
      background: #faf9fb;
      color: #4a3f47;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #ec4899;
      background: white;
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: #b9a2b3;
    }

    @media (min-width: 768px) {
      .empty-state {
        padding: 48px 24px;
      }
    }

    .empty-state-icon {
      font-size: clamp(32px, 8vw, 48px);
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: clamp(11px, 2vw, 14px);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .master-data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
    }

    @media (min-width: 768px) {
      .master-data-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }
    }

    .master-card {
      background: white;
      border-radius: 10px;
      padding: 14px;
      border: 2px solid rgba(236, 72, 153, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    @media (min-width: 768px) {
      .master-card {
        padding: 18px;
        border-radius: 12px;
      }
    }

    .master-card-content {
      flex: 1;
    }

    .master-card-name {
      font-size: clamp(12px, 2.5vw, 14px);
      font-weight: 700;
      color: #d946a6;
      margin: 0 0 4px 0;
    }

    .master-card-detail {
      font-size: clamp(10px, 2vw, 12px);
      color: #b9a2b3;
      margin: 0;
    }

    .master-card-actions {
      display: flex;
      gap: 6px;
      margin-left: 8px;
      flex-wrap: wrap;
    }

    .btn-edit, .btn-delete {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: clamp(9px, 1.5vw, 11px);
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-edit {
      background: #a855f7;
      color: white;
    }

    .btn-edit:hover {
      background: #9333ea;
    }

    .btn-delete {
      background: #ef4444;
      color: white;
    }

    .btn-delete:hover {
      background: #dc2626;
    }

    #modal {
      border-radius: 12px;
      padding: 24px;
      min-width: calc(100% - 32px);
      max-width: 450px;
      max-height: 90vh;
      overflow-y: auto;
    }

    @media (min-width: 768px) {
      #modal {
        padding: 32px;
        min-width: 400px;
        border-radius: 16px;
      }
    }

    #modal-title {
      margin: 0 0 20px 0;
      color: #ec4899;
      font-size: clamp(14px, 3vw, 18px);
      font-weight: 700;
      text-transform: uppercase;
    }

    .toast {
      background: white;
      color: #4a3f47;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      font-size: clamp(11px, 2vw, 13px);
      font-weight: 600;
      animation: slideIn 0.3s ease;
      pointer-events: auto;
      border-left: 4px solid #ec4899;
    }

    @media (min-width: 768px) {
      .toast {
        padding: 16px 24px;
        border-radius: 10px;
      }
    }

    .text-gray-400 {
      color: #b9a2b3;
    }

    .text-xs {
      font-size: clamp(10px, 2vw, 12px);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="app">
   <div class="header">
    <div class="header-content">
     <h1>‚ú® OEE KEMAS SEKUNDER</h1>
     <p>Created by MSTD GOF</p>
    </div>
    <div style="display: flex; flex-direction: column; gap: 16px; align-items: flex-end;">
     <div class="header-datetime">
      <div class="header-datetime-time" id="current-time">
       00:00:00
      </div>
      <div id="current-date">
       Tanggal
      </div>
     </div><button class="mode-toggle" onclick="toggleDarkMode()"> <span id="mode-icon">üåô</span> <span id="mode-text">Dark</span> </button>
    </div>
   </div>
   <div class="tabs-container"><button class="tab-btn active" onclick="switchTab('input')">‚úèÔ∏è INPUT OEE</button> <button class="tab-btn" onclick="switchTab('dashboard')">üìà DASHBOARD</button> <button class="tab-btn" onclick="switchTab('master')">üíæ MASTER DATA</button> <button class="tab-btn" onclick="switchTab('audit')">‚öôÔ∏è AUDIT TRAIL</button>
   </div>
   <div class="content"><!-- INPUT OEE TAB -->
    <div id="input" class="tab-content active">
     <form id="form-oee" onsubmit="submitOEE(event)">
      <div class="form-section">
       <div class="section-title">
        Informasi Shift
       </div>
       <div class="form-row">
        <div class="form-group"><label>Tanggal</label> <input type="date" id="oee-date" required>
        </div>
        <div class="form-group"><label>Shift</label> <select id="oee-shift" onchange="updateShiftMinutes()"> <option value="">-- Pilih Shift --</option> <option value="Shift 1">Shift 1 (07:00 - 15:30)</option> <option value="Shift 2">Shift 2 (15:20 - 22:50)</option> <option value="Shift 3">Shift 3 (22:40 - 07:10)</option> <option value="Longshift Pagi">Longshift Pagi (07:00 - 19:00)</option> <option value="Longshift Malam">Longshift Malam (19:00 - 07:00)</option> </select>
        </div>
       </div>
      </div>
      <div class="form-section">
       <div class="section-title">
        Packer Meter
       </div><button type="button" class="btn btn-success" onclick="addPackerMeter()">+ Tambah Meter</button>
       <div id="packer-meter-list" style="margin-top: 16px;"></div>
      </div>
      <div class="form-section">
       <div class="section-title">
        Operational Downtime (ODT)
       </div>
       <div id="odt-list"></div>
      </div>
      <div class="form-section">
       <div class="section-title">
        Line Stop Mesin
       </div>
       <div id="line-stop-mesin-list"></div>
      </div>
      <div class="form-section">
       <div class="section-title">
        Line Stop Non-Mesin
       </div>
       <div id="line-stop-non-mesin-list"></div>
      </div>
      <div class="form-section">
       <div class="section-title">
        Minor Stop
       </div><button type="button" class="btn btn-success" onclick="addMinorStop()">+ Tambah Minor Stop</button>
       <div id="minor-stop-list" style="margin-top: 16px;"></div>
      </div>
      <div class="form-section">
       <div id="availability-warning" style="display: none;"></div>
       <div class="section-title">
        Hasil Perhitungan OEE
       </div>
       <div class="score-cards">
        <div class="score-card">
         <div class="score-label">
          Availability (Actual)
         </div>
         <div class="score-value" id="calc-availability-actual">
          0%
         </div>
        </div>
        <div class="score-card">
         <div class="score-label">
          Performance
         </div>
         <div class="score-value" id="calc-performance">
          0%
         </div>
        </div>
        <div class="score-card">
         <div class="score-label">
          Quality Rate
         </div>
         <div class="score-value" id="calc-quality">
          0%
         </div>
        </div>
        <div class="score-card">
         <div class="score-label">
          OEE (Actual)
         </div>
         <div class="score-value" id="calc-oee-actual">
          0%
         </div>
        </div>
        <div class="score-card">
         <div class="score-label">
          OEE (365)
         </div>
         <div class="score-value" id="calc-oee-365">
          0%
         </div>
        </div>
        <div class="score-card">
         <div class="score-label">
          Total Output
         </div>
         <div class="score-value" id="calc-total-output" style="font-size: 24px;">
          0 DUS
         </div>
        </div>
       </div>
      </div>
      <div class="form-section" style="text-align: center;"><button type="submit" class="btn btn-primary" style="margin-right: 12px;">üíæ Simpan Data OEE</button> <button type="button" class="btn btn-secondary" onclick="resetOEEForm()">ÔøΩÔøΩ Reset Form</button>
      </div>
     </form>
    </div><!-- DASHBOARD TAB -->
    <div id="dashboard" class="tab-content">
     <div class="form-section">
      <div class="section-title">
       Filter Data
      </div>
      <div class="filter-group">
       <div class="form-group"><label>Tanggal Mulai</label> <input type="date" id="filter-date-start" class="input-field" onchange="applyDashboardFilters()">
       </div>
       <div class="form-group"><label>Tanggal Akhir</label> <input type="date" id="filter-date-end" class="input-field" onchange="applyDashboardFilters()">
       </div>
       <div class="form-group"><label>Produk</label> <select id="filter-product" class="input-field" onchange="applyDashboardFilters()"> <option value="">-- Semua Produk --</option> </select>
       </div>
       <div class="form-group"><label>Packer</label> <select id="filter-packer" class="input-field" onchange="applyDashboardFilters()"> <option value="">-- Semua Packer --</option> </select>
       </div>
       <div style="display: flex; align-items: flex-end;"><button class="btn btn-secondary" onclick="resetDashboardFilters()" style="width: 100%;">Reset Filter</button>
       </div>
      </div>
     </div>
     <div class="score-cards">
      <div class="score-card" id="score-card-oee-actual">
       <div class="score-label">
        OEE Actual
       </div>
       <div class="score-value" id="score-oee-actual">
        0%
       </div>
      </div>
      <div class="score-card" id="score-card-oee-365">
       <div class="score-label">
        OEE 365
       </div>
       <div class="score-value" id="score-oee-365">
        0%
       </div>
      </div>
      <div class="score-card">
       <div class="score-label">
        Total Output
       </div>
       <div class="score-value" id="score-total-output" style="font-size: 24px;">
        0
       </div>
      </div>
     </div>
     <div class="chart-container">
      <div class="chart-title">
       OEE Per Bulan (12 Bulan)
      </div>
      <canvas id="chart-oee-monthly" height="80"></canvas>
     </div>
     <div class="chart-container">
      <div class="chart-title">
       OEE Per Hari (30 Hari Terakhir)
      </div>
      <canvas id="chart-oee-daily" height="80"></canvas>
     </div>
     <div class="chart-container">
      <div class="chart-title">
       A / P / Q / 365 Breakdown
      </div>
      <canvas id="chart-apqa-breakdown" height="100"></canvas>
     </div>
     <div class="chart-container">
      <div class="chart-title">
       Top 10 ODT (Menit)
      </div>
      <canvas id="chart-odt-top10" height="200"></canvas>
     </div>
     <div class="chart-container">
      <div class="chart-title">
       Top 10 Line Stop Mesin (Menit)
      </div>
      <canvas id="chart-lsm-top10" height="200"></canvas>
     </div>
     <div class="chart-container">
      <div class="chart-title">
       Top 10 Line Stop Non-Mesin (Menit)
      </div>
      <canvas id="chart-lsnm-top10" height="200"></canvas>
     </div>
     <div class="chart-container">
      <div class="chart-title">
       Top 10 Minor Stop (Menit)
      </div>
      <canvas id="chart-ms-top10" height="200"></canvas>
     </div>
     <div class="form-section">
      <div class="section-title">
       Performa Packer
      </div>
      <div class="table-wrapper">
       <table>
        <thead>
         <tr>
          <th>No</th>
          <th>Packer</th>
          <th>Avg OEE Actual</th>
          <th>Total Output</th>
          <th>Records</th>
         </tr>
        </thead>
        <tbody id="table-packer-performance"></tbody>
       </table>
      </div>
     </div>
     <div class="form-section">
      <div class="section-title">
       Riwayat OEE
      </div>
      <div class="table-wrapper">
       <table>
        <thead>
         <tr>
          <th>Tanggal</th>
          <th>Shift</th>
          <th>Nomor Batch</th>
          <th>OEE Actual</th>
          <th>OEE 365</th>
          <th>Abnormalitas LSM</th>
          <th>Action LSM</th>
          <th>Abnormalitas LSNM</th>
          <th>Action LSNM</th>
         </tr>
        </thead>
        <tbody id="table-oee-history"></tbody>
       </table>
      </div>
     </div>
    </div><!-- MASTER DATA TAB -->
    <div id="master" class="tab-content">
     <div class="form-section">
      <div class="section-title">
       Master Produk
      </div><button class="btn btn-primary" onclick="openAddProductModal()">+ Produk Baru</button>
      <div id="product-list" class="master-data-grid" style="margin-top: 16px;"></div>
     </div>
     <div class="form-section">
      <div class="section-title">
       Master Packer
      </div><button class="btn btn-primary" onclick="openAddPackerModal()">+ Packer Baru</button>
      <div id="packer-list" class="master-data-grid" style="margin-top: 16px;"></div>
     </div>
     <div class="form-section">
      <div class="section-title">
       Master ODT
      </div><button class="btn btn-primary" onclick="openAddODTModal()">+ ODT Baru</button>
      <div id="odt-master-list" class="master-data-grid" style="margin-top: 16px;"></div>
     </div>
     <div class="form-section">
      <div class="section-title">
       Master Line Stop Mesin
      </div><button class="btn btn-primary" onclick="openAddLineStopMesinModal()">+ Line Stop Baru</button>
      <div id="line-stop-mesin-master-list" class="master-data-grid" style="margin-top: 16px;"></div>
     </div>
     <div class="form-section">
      <div class="section-title">
       Master Line Stop Non-Mesin
      </div><button class="btn btn-primary" onclick="openAddLineStopNonMesinModal()">+ Line Stop Baru</button>
      <div id="line-stop-non-mesin-master-list" class="master-data-grid" style="margin-top: 16px;"></div>
     </div>
     <div class="form-section">
      <div class="section-title">
       Master Minor Stop
      </div><button class="btn btn-primary" onclick="openAddMinorStopModal()">+ Minor Stop Baru</button>
      <div id="minor-stop-master-list" class="master-data-grid" style="margin-top: 16px;"></div>
     </div>
    </div><!-- AUDIT TRAIL TAB -->
    <div id="audit" class="tab-content">
     <div class="form-section">
      <div class="section-title">
       Riwayat Aktivitas
      </div>
      <div class="table-wrapper">
       <table>
        <thead>
         <tr>
          <th>Waktu</th>
          <th>Aktivitas</th>
          <th>Detail</th>
         </tr>
        </thead>
        <tbody id="audit-table"></tbody>
       </table>
      </div>
     </div>
    </div>
   </div>
  </div>
  <div id="toast-container" class="toast-container"></div><!-- Modal Backdrop -->
  <div id="modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9998;" onclick="if(event.target === this) closeModal();"></div><!-- Modal -->
  <div id="modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 32px; z-index: 9999; min-width: 400px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
   <h2 id="modal-title" style="margin: 0 0 24px 0; color: #ec4899; font-size: 18px; font-weight: 700; text-transform: uppercase;">Modal Title</h2>
   <form id="modal-form" onsubmit="submitModalForm(event)">
    <div id="modal-fields"></div>
    <div style="display: flex; gap: 12px; margin-top: 24px;"><button type="submit" class="btn btn-primary" style="flex: 1;">Simpan</button> <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Batal</button>
    </div>
   </form>
  </div>
  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://lxtnhdyxrkjbypahdsrf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4dG5oZHl4cmtqYnlwYWhkc3JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3ODI5MDIsImV4cCI6MjA4NjM1ODkwMn0.BtC1iFgNydjy6gWmk7HPXt70UcgnBCsWj8H89WqfRwA';
    let supabaseClient = null;
    
    if (window.supabase) {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    let localData = {
      produk: [],
      packer: [],
      downtime: [],
      line_stop_mesin: [],
      line_stop_non_mesin: [],
      minor_stop: [],
      oee_records: [],
      audit_trail: []
    };

    let oeeFormState = {
      shiftMinutes: 0,
      packerMeters: [],
      downtime: [],
      lineStopMesin: [],
      lineStopNonMesin: [],
      minorStop: [],
      results: {}
    };

    async function initApp() {
      await loadDataFromSupabase();
      loadOEEFormData();
      renderMasterDataLists();
      renderAuditTable();
      initDashboardFilters();
      updateDashboard();
    }

    window.switchTab = function(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
      
      if (tabName === 'dashboard') {
        setTimeout(() => {
          renderCharts();
        }, 100);
      }
    };

    async function loadDataFromSupabase() {
      try {
        // Load all data from Supabase tables
        const [produkRes, packerRes, downtimeRes, lsmRes, lsnmRes, msRes, oeeRes, auditRes] = await Promise.all([
          supabaseClient.from('produk').select('*'),
          supabaseClient.from('packer').select('*'),
          supabaseClient.from('downtime').select('*'),
          supabaseClient.from('line_stop_mesin').select('*'),
          supabaseClient.from('line_stop_non_mesin').select('*'),
          supabaseClient.from('minor_stop').select('*'),
          supabaseClient.from('oee_records').select('*').order('created_at', { ascending: false }),
          supabaseClient.from('audit_trail').select('*').order('timestamp', { ascending: false })
        ]);

        localData.produk = produkRes.data || [];
        localData.packer = packerRes.data || [];
        localData.downtime = downtimeRes.data || [];
        localData.line_stop_mesin = lsmRes.data || [];
        localData.line_stop_non_mesin = lsnmRes.data || [];
        localData.minor_stop = msRes.data || [];
        localData.oee_records = oeeRes.data || [];
        localData.audit_trail = auditRes.data || [];
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading data from Supabase', 'error');
      }
    }

    function updateShiftMinutes() {
      const shift = document.getElementById('oee-shift').value;
      const shiftSchedule = {
        'Shift 1': 510,
        'Shift 2': 510,
        'Shift 3': 510,
        'Longshift Pagi': 720,
        'Longshift Malam': 720
      };
      oeeFormState.shiftMinutes = shiftSchedule[shift] || 0;
      renderODTList();
      renderLineStopMesinList();
      renderLineStopNonMesinList();
      renderMinorStopList();
    }

    function addPackerMeter() {
      const shift = document.getElementById('oee-shift').value;
      if (!shift) {
        showToast('Pilih shift terlebih dahulu', 'error');
        return;
      }

      oeeFormState.packerMeters.push({
        id: 'meter_' + Date.now(),
        productId: '',
        batchNumber: '',
        totalOutput: 0,
        totalReject: 0,
        packers: []
      });
      renderPackerMeterList();
    }

    function renderPackerMeterList() {
      const listDiv = document.getElementById('packer-meter-list');
      if (oeeFormState.packerMeters.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ÔøΩÔøΩ</div><div class="empty-state-text">Belum ada meter ditambahkan</div></div>';
        return;
      }

      listDiv.innerHTML = oeeFormState.packerMeters.map(meter => `
        <div class="card" data-meter-id="${meter.id}">
          <div class="card-header">
            <h3 class="card-title">Meter ${oeeFormState.packerMeters.indexOf(meter) + 1}</h3>
            <button type="button" class="btn btn-danger btn-small" onclick="removePackerMeter('${meter.id}')">Hapus</button>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Produk</label>
              <select class="meter-product input-field" onchange="updatePackerMeter('${meter.id}', 'product')">
                <option value="">-- Pilih Produk --</option>
                ${localData.produk.map(p => `<option value="${p.id}" ${meter.productId === p.id ? 'selected' : ''}>${p.nama}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Batch Number</label>
              <input type="text" class="meter-batch input-field" value="${meter.batchNumber}" placeholder="Batch Number" onchange="updatePackerMeter('${meter.id}', 'batch')">
            </div>
          </div>

          <div style="margin-top: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h4 class="section-title" style="margin: 0;">Packer</h4>
              <button type="button" class="btn btn-success btn-small" onclick="addPackerToMeter('${meter.id}')">+ Packer</button>
            </div>
            <div id="packers-${meter.id}"></div>
          </div>
        </div>
      `).join('');

      oeeFormState.packerMeters.forEach(meter => {
        renderPackersInMeter(meter);
      });
    }

    function renderPackersInMeter(meter) {
      const container = document.getElementById(`packers-${meter.id}`);
      if (!container) return;

      if (meter.packers.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-text" style="font-size: 12px;">Tambah packer untuk meter ini</div></div>';
        return;
      }

      container.innerHTML = meter.packers.map(packer => `
        <div id="packer-${packer.id}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); gap: 8px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid rgba(236, 72, 153, 0.1);">
          <div class="form-group">
            <label style="font-size: 10px;">Packer</label>
            <select class="packer-name input-field" style="font-size: 11px;" onchange="updatePacker('${packer.id}', '${meter.id}')">
              <option value="">Pilih</option>
              ${localData.packer.map(p => `<option value="${p.id}|${p.nama}" ${packer.packerId === p.id ? 'selected' : ''}>${p.nama}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label style="font-size: 10px;">Start</label>
            <input type="time" class="packer-start-time input-field" style="font-size: 11px;" value="${packer.startTime}" onchange="updatePacker('${packer.id}', '${meter.id}')">
          </div>
          <div class="form-group">
            <label style="font-size: 10px;">End</label>
            <input type="time" class="packer-end-time input-field" style="font-size: 11px;" value="${packer.endTime}" onchange="updatePacker('${packer.id}', '${meter.id}')">
          </div>
          <div class="form-group">
            <label style="font-size: 10px;">Durasi (Min)</label>
            <input type="number" class="packer-duration input-field" style="font-size: 11px;" value="${packer.duration}" readonly>
          </div>
          <div class="form-group">
            <label style="font-size: 10px;">Output (DUS)</label>
            <input type="number" class="packer-output input-field" style="font-size: 11px;" value="${packer.output}" placeholder="Output" onchange="updatePacker('${packer.id}', '${meter.id}')">
          </div>
          <div class="form-group">
            <label style="font-size: 10px;">Reject (DUS)</label>
            <input type="number" class="packer-reject input-field" style="font-size: 11px;" value="${packer.reject}" placeholder="Reject" onchange="updatePacker('${packer.id}', '${meter.id}')">
          </div>
          <div style="display: flex; align-items: flex-end;">
            <button type="button" class="btn btn-danger btn-small" style="width: 100%; padding: 8px; font-size: 11px;" onclick="removePacker('${packer.id}', '${meter.id}')">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function removePackerMeter(meterId) {
      oeeFormState.packerMeters = oeeFormState.packerMeters.filter(m => m.id !== meterId);
      renderPackerMeterList();
      calculateOEE();
    }

    function addPackerToMeter(meterId) {
      const meter = oeeFormState.packerMeters.find(m => m.id === meterId);
      if (!meter) return;

      const shift = document.getElementById('oee-shift').value;
      const shiftSchedule = {
        'Shift 1': { start: '07:00', end: '15:30' },
        'Shift 2': { start: '15:20', end: '22:50' },
        'Shift 3': { start: '22:40', end: '07:10' },
        'Longshift Pagi': { start: '07:00', end: '19:00' },
        'Longshift Malam': { start: '19:00', end: '07:00' }
      };
      const schedule = shiftSchedule[shift] || { start: '07:00', end: '15:30' };

      meter.packers.push({
        id: 'packer_' + Date.now(),
        packerId: '',
        packerName: '',
        startTime: schedule.start,
        endTime: schedule.end,
        duration: 0,
        output: 0,
        reject: 0
      });

      renderPackersInMeter(meter);
    }

    function updatePackerMeter(meterId, field) {
      const meter = oeeFormState.packerMeters.find(m => m.id === meterId);
      if (!meter) return;

      const meterDiv = document.querySelector(`[data-meter-id="${meterId}"]`);
      if (!meterDiv) return;

      if (field === 'product') {
        meter.productId = meterDiv.querySelector('.meter-product').value;
      } else if (field === 'batch') {
        meter.batchNumber = meterDiv.querySelector('.meter-batch').value;
      } else if (field === 'output') {
        meter.totalOutput = parseFloat(meterDiv.querySelector('.meter-total-output').value) || 0;
      } else if (field === 'reject') {
        meter.totalReject = parseFloat(meterDiv.querySelector('.meter-total-reject').value) || 0;
      }

      calculateOEE();
    }

    function updatePacker(packerId, meterId) {
      const meter = oeeFormState.packerMeters.find(m => m.id === meterId);
      if (!meter) return;

      const packer = meter.packers.find(p => p.id === packerId);
      if (!packer) return;

      const packerDiv = document.getElementById(`packer-${packerId}`);
      if (!packerDiv) return;

      const nameSelect = packerDiv.querySelector('.packer-name');
      const startTimeInput = packerDiv.querySelector('.packer-start-time');
      const endTimeInput = packerDiv.querySelector('.packer-end-time');
      const durationInput = packerDiv.querySelector('.packer-duration');
      const outputInput = packerDiv.querySelector('.packer-output');
      const rejectInput = packerDiv.querySelector('.packer-reject');

      const [packerId_, packerName] = nameSelect.value.split('|') || ['', ''];
      packer.packerId = packerId_;
      packer.packerName = packerName;
      packer.startTime = startTimeInput.value;
      packer.endTime = endTimeInput.value;
      packer.output = parseFloat(outputInput.value) || 0;
      packer.reject = parseFloat(rejectInput.value) || 0;

      if (packer.startTime && packer.endTime) {
        const [startHour, startMin] = packer.startTime.split(':').map(Number);
        const [endHour, endMin] = packer.endTime.split(':').map(Number);

        let startTotalMin = startHour * 60 + startMin;
        let endTotalMin = endHour * 60 + endMin;

        if (endTotalMin <= startTotalMin) {
          endTotalMin += 24 * 60;
        }

        packer.duration = Math.max(0, endTotalMin - startTotalMin);
        durationInput.value = packer.duration;
      }

      calculateOEE();
    }

    function removePacker(packerId, meterId) {
      const meter = oeeFormState.packerMeters.find(m => m.id === meterId);
      if (meter) {
        meter.packers = meter.packers.filter(p => p.id !== packerId);
        renderPackersInMeter(meter);
      }
      calculateOEE();
    }

    function renderODTList() {
      const listDiv = document.getElementById('odt-list');
      if (localData.downtime.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-text">Belum ada data ODT</div></div>';
        return;
      }

      if (oeeFormState.downtime.length === 0) {
        oeeFormState.downtime = localData.downtime.map(d => ({ id: d.id, nama: d.nama, waktu_standard: d.waktu_standard, durasi: 0 }));
      }

      listDiv.innerHTML = oeeFormState.downtime.map(odt => `
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; align-items: center; margin-bottom: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
          <div>
            <p style="font-size: 13px; font-weight: 700; color: #3b82f6; margin: 0 0 4px 0; text-transform: uppercase;">${odt.nama}</p>
            <p style="font-size: 11px; color: #60a5fa; margin: 0; text-transform: uppercase;">STD: ${odt.waktu_standard} menit</p>
          </div>
          <input type="number" class="input-field" value="${odt.durasi}" min="0" placeholder="Durasi Aktual" onchange="updateODT('${odt.id}', this.value)">
        </div>
      `).join('');
    }

    function updateODT(id, durasi) {
      const odt = oeeFormState.downtime.find(o => o.id === id);
      if (odt) {
        odt.durasi = parseFloat(durasi) || 0;
      }
      calculateOEE();
    }

    function renderLineStopMesinList() {
      const listDiv = document.getElementById('line-stop-mesin-list');
      if (localData.line_stop_mesin.length === 0 && oeeFormState.lineStopMesin.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-text">Belum ada data</div></div>';
        return;
      }

      if (oeeFormState.lineStopMesin.length === 0) {
        oeeFormState.lineStopMesin = localData.line_stop_mesin.map(m => ({ id: m.id, nama: m.nama, durasi: 0, action: '', wr: '', isCustom: false }));
      }

      listDiv.innerHTML = oeeFormState.lineStopMesin.map(lsm => {
        const durasi = parseFloat(lsm.durasi) || 0;
        const wrRequired = durasi >= 180;
        return `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; padding: 12px; background: #faf5ff; border-radius: 8px; align-items: center; margin-bottom: 8px; border: 1px solid rgba(168, 85, 247, 0.2);">
            <div>
              <p style="font-size: 13px; font-weight: 700; color: #a855f7; margin: 0; text-transform: uppercase;">${lsm.nama}</p>
            </div>
            <input type="number" class="input-field" value="${lsm.durasi}" min="0" placeholder="Durasi (Min)" onchange="updateLineStopMesin('${lsm.id}', 'durasi', this.value)">
            <input type="text" class="input-field" value="${lsm.action}" placeholder="Action" onchange="updateLineStopMesin('${lsm.id}', 'action', this.value)">
            <input type="text" class="input-field" style="${wrRequired ? 'border-color: #ef4444;' : ''}" value="${lsm.wr}" placeholder="No WR${wrRequired ? ' *' : ''}" onchange="updateLineStopMesin('${lsm.id}', 'wr', this.value)">
          </div>
        `;
      }).join('');
    }

    function updateLineStopMesin(id, field, value) {
      const lsm = oeeFormState.lineStopMesin.find(l => l.id === id);
      if (lsm) lsm[field] = value;
      calculateOEE();
    }

    function renderLineStopNonMesinList() {
      const listDiv = document.getElementById('line-stop-non-mesin-list');
      if (localData.line_stop_non_mesin.length === 0 && oeeFormState.lineStopNonMesin.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-text">Belum ada data</div></div>';
        return;
      }

      if (oeeFormState.lineStopNonMesin.length === 0) {
        oeeFormState.lineStopNonMesin = localData.line_stop_non_mesin.map(m => ({ id: m.id, nama: m.nama, durasi: 0, action: '', checked: false, isCustom: false }));
      }

      listDiv.innerHTML = oeeFormState.lineStopNonMesin.map(lsnm => `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; padding: 12px; background: #f0fdf4; border-radius: 8px; align-items: center; margin-bottom: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="lsnm-${lsnm.id}" ${lsnm.checked ? 'checked' : ''} onchange="updateLineStopNonMesin('${lsnm.id}', 'checked', this.checked); renderLineStopNonMesinList();">
            <label for="lsnm-${lsnm.id}" style="font-size: 13px; font-weight: 600; color: #10b981; margin: 0; text-transform: uppercase; cursor: pointer;">${lsnm.nama}</label>
          </div>
          <input type="number" class="input-field" value="${lsnm.durasi}" min="0" placeholder="Durasi (Min)" ${!lsnm.checked ? 'disabled' : ''} onchange="updateLineStopNonMesin('${lsnm.id}', 'durasi', this.value)">
          <input type="text" class="input-field" value="${lsnm.action}" placeholder="Action" ${!lsnm.checked ? 'disabled' : ''} onchange="updateLineStopNonMesin('${lsnm.id}', 'action', this.value)">
        </div>
      `).join('');
    }

    function updateLineStopNonMesin(id, field, value) {
      const lsnm = oeeFormState.lineStopNonMesin.find(l => l.id === id);
      if (lsnm) {
        if (field === 'checked') {
          lsnm.checked = value;
          if (!value) {
            lsnm.durasi = 0;
            lsnm.action = '';
          }
        } else {
          lsnm[field] = value;
        }
      }
      calculateOEE();
    }

    function addMinorStop() {
      oeeFormState.minorStop.push({
        id: 'ms_' + Date.now(),
        nama: '',
        durasi: 0,
        checked: false,
        isCustom: true
      });
      renderMinorStopList();
    }

    function renderMinorStopList() {
      const listDiv = document.getElementById('minor-stop-list');
      if (localData.minor_stop.length === 0 && oeeFormState.minorStop.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-text">Belum ada data</div></div>';
        return;
      }

      if (oeeFormState.minorStop.length === 0) {
        oeeFormState.minorStop = localData.minor_stop.map(m => ({ id: m.id, nama: m.nama, durasi: 0, checked: false, isCustom: false }));
      }

      listDiv.innerHTML = oeeFormState.minorStop.map(ms => `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; padding: 12px; background: #fef3c7; border-radius: 8px; align-items: center; margin-bottom: 8px; border: 1px solid rgba(217, 119, 6, 0.2);">
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="ms-${ms.id}" ${ms.checked ? 'checked' : ''} onchange="updateMinorStop('${ms.id}', 'checked', this.checked); renderMinorStopList();">
            <label for="ms-${ms.id}" style="font-size: 13px; font-weight: 600; color: #d97706; margin: 0; text-transform: uppercase; cursor: pointer;">${ms.nama}</label>
          </div>
          <input type="number" class="input-field" value="${ms.durasi}" min="0" placeholder="Durasi (Min)" ${!ms.checked ? 'disabled' : ''} onchange="updateMinorStop('${ms.id}', 'durasi', this.value)">
          ${ms.isCustom ? `<button type="button" class="btn btn-danger btn-small" style="padding: 8px;" onclick="removeMinorStop('${ms.id}')">Hapus</button>` : ''}
        </div>
      `).join('');
    }

    function updateMinorStop(id, field, value) {
      const ms = oeeFormState.minorStop.find(m => m.id === id);
      if (ms) {
        if (field === 'checked') {
          ms.checked = value;
          if (!value) {
            ms.durasi = 0;
          }
        } else {
          ms[field] = value;
        }
      }
      calculateOEE();
    }

    function removeMinorStop(id) {
      oeeFormState.minorStop = oeeFormState.minorStop.filter(m => m.id !== id);
      renderMinorStopList();
      calculateOEE();
    }

    function calculateOEE() {
      let totalOutputActual = 0;
      let totalRejectActual = 0;
      let totalShiftMinutes = oeeFormState.shiftMinutes;
      let meterDetails = [];

      // Calculate total packer duration (RUNNING TIME) dan total output/reject dari semua packer
      let totalPackerDuration = 0;
      oeeFormState.packerMeters.forEach(meter => {
        meter.packers.forEach(packer => {
          totalPackerDuration += packer.duration || 0;
          totalOutputActual += packer.output || 0;
          totalRejectActual += packer.reject || 0;
        });
      });

      // Calculate total ODT ACTUAL (bukan standard) - hanya yang diinput user
      const totalODT = oeeFormState.downtime.reduce((sum, odt) => sum + (parseFloat(odt.durasi) || 0), 0);
      
      // Calculate line stops and minor stops (optional/actual downtime)
      const totalLineStopMesin = oeeFormState.lineStopMesin.reduce((sum, l) => sum + (parseFloat(l.durasi) || 0), 0);
      const totalLineStopNonMesin = oeeFormState.lineStopNonMesin.filter(l => l.checked).reduce((sum, l) => sum + (parseFloat(l.durasi) || 0), 0);
      const totalMinorStop = oeeFormState.minorStop.filter(m => m.checked).reduce((sum, m) => sum + (parseFloat(m.durasi) || 0), 0);
      const totalActualDowntime = totalLineStopMesin + totalLineStopNonMesin + totalMinorStop;

      // Total downtime = ODT actual + Line Stop (all types)
      const totalDowntime = totalODT + totalActualDowntime;

      // Check if RUNNING METER + ODT ACTUAL + LINE STOP exceeds shift minutes
      const totalTimeUsed = totalPackerDuration + totalDowntime;
      oeeFormState.availabilityWarning = totalTimeUsed > totalShiftMinutes;

      // Calculate availability based on OEE formula
      // Availability Actual = (Jam Kerja - Total ODT - Line Stop Mesin - Line Stop Non-Mesin) / (Jam Kerja - Total ODT)
      // Availability 365 = (Jam Kerja - Total ODT - Line Stop Mesin - Line Stop Non-Mesin) / Jam Kerja
      
      const plannedProductionTime = totalShiftMinutes - totalODT;
      const availableTime = plannedProductionTime - totalActualDowntime;
      
      const availabilityActual = plannedProductionTime > 0 ? (availableTime / plannedProductionTime) * 100 : 0;
      const availability365 = totalShiftMinutes > 0 ? (availableTime / totalShiftMinutes) * 100 : 0;

      let totalTargetOutputAllBatches = 0;
      
      oeeFormState.packerMeters.forEach(meter => {
        const product = localData.produk.find(p => p.id === meter.productId);
        if (!product) return;
        
        let meterActualOutput = 0;
        let meterActualReject = 0;
        let meterTargetOutput = 0;
        let packerBreakdown = [];
        
        meter.packers.forEach(packer => {
          const packerDuration = packer.duration || 0;
          const packerTarget = packerDuration * product.target;
          const packerActual = packer.output;
          const packerReject = packer.reject;
          const packerPerformance = packerTarget > 0 ? (packerActual / packerTarget) * 100 : 0;
          
          meterActualOutput += packerActual;
          meterActualReject += packerReject;
          meterTargetOutput += packerTarget;
          
          packerBreakdown.push({
            name: packer.packerName,
            duration: packerDuration,
            target: packerTarget,
            actual: packerActual,
            reject: packerReject,
            performance: packerPerformance.toFixed(1)
          });
        });
        
        const meterPerformance = meterTargetOutput > 0 ? (meterActualOutput / meterTargetOutput) * 100 : 0;
        
        meterDetails.push({
          batchNumber: meter.batchNumber,
          product: product.nama,
          actualOutput: meterActualOutput,
          actualReject: meterActualReject,
          targetOutput: meterTargetOutput,
          performance: meterPerformance.toFixed(1),
          packers: packerBreakdown
        });
        
        totalTargetOutputAllBatches += meterTargetOutput;
      });

      const performance = totalTargetOutputAllBatches > 0 ? (totalOutputActual / totalTargetOutputAllBatches) * 100 : 0;
      const qualityRate = totalOutputActual > 0 ? (((totalOutputActual - totalRejectActual) / totalOutputActual) * 100) : 0;

      const oeeActual = (availabilityActual / 100) * (performance / 100) * (qualityRate / 100) * 100;
      const oee365 = (performance / 100) * (qualityRate / 100) * 100;

      document.getElementById('calc-availability-actual').textContent = `${availabilityActual.toFixed(1)}%`;
      document.getElementById('calc-performance').textContent = `${performance.toFixed(1)}%`;
      document.getElementById('calc-quality').textContent = `${qualityRate.toFixed(1)}%`;
      document.getElementById('calc-oee-actual').textContent = `${oeeActual.toFixed(1)}%`;
      document.getElementById('calc-oee-365').textContent = `${oee365.toFixed(1)}%`;
      document.getElementById('calc-total-output').textContent = `${totalOutputActual.toFixed(1)} DUS`;

      // Show warning if total running time + downtime exceeds shift duration
      const warningDiv = document.getElementById('availability-warning');
      if (warningDiv) {
        if (oeeFormState.availabilityWarning) {
          warningDiv.innerHTML = `
            <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 10px; padding: 16px; margin-bottom: 16px; color: #dc2626;">
              <p style="margin: 0 0 8px 0; font-weight: 700; text-transform: uppercase; font-size: 13px;">‚ö†Ô∏è Warning: Waktu Tidak Sesuai</p>
              <p style="margin: 0; font-size: 12px;">Total waktu kerja (running meter ${totalPackerDuration.toFixed(0)} + ODT ${totalODT.toFixed(0)} + line stop ${totalActualDowntime.toFixed(0)} = ${totalTimeUsed.toFixed(0)} menit) melebihi durasi shift (${totalShiftMinutes.toFixed(0)} menit). Periksa kembali data Anda.</p>
            </div>
          `;
          warningDiv.style.display = 'block';
        } else {
          warningDiv.style.display = 'none';
        }
      }

      oeeFormState.results = {
        availabilityActual: availabilityActual.toFixed(1),
        availability365: availability365.toFixed(1),
        performance: performance.toFixed(1),
        qualityRate: qualityRate.toFixed(1),
        oeeActual: oeeActual.toFixed(1),
        oee365: oee365.toFixed(1),
        totalOutput: totalOutputActual,
        totalReject: totalRejectActual,
        meterDetails: meterDetails,
        totalPackerDuration: totalPackerDuration,
        totalDowntime: totalDowntime
      };
    }

    function loadOEEFormData() {
      document.getElementById('oee-date').value = new Date().toISOString().split('T')[0];
    }

    async function submitOEE(event) {
      event.preventDefault();
      
      const date = document.getElementById('oee-date').value;
      const shift = document.getElementById('oee-shift').value;

      if (!date || !shift || oeeFormState.packerMeters.length === 0) {
        showToast('Tanggal, shift & packer meter wajib diisi', 'error');
        return;
      }

      const invalidMeter = oeeFormState.packerMeters.find(m => !m.productId || !m.batchNumber || m.packers.length === 0);
      if (invalidMeter) {
        showToast('Produk, batch & minimal 1 packer wajib diisi di setiap meter', 'error');
        return;
      }

      const invalidPacker = oeeFormState.packerMeters.flatMap((m, mIdx) => 
        m.packers.filter(p => !p.packerName).map(() => mIdx)
      );
      if (invalidPacker.length > 0) {
        showToast('Semua packer harus dipilih', 'error');
        return;
      }

      const invalidWR = oeeFormState.lineStopMesin.find(lsm => parseFloat(lsm.durasi) >= 180 && !lsm.wr?.trim());
      if (invalidWR) {
        showToast(`No WR wajib untuk: ${invalidWR.nama}`, 'error');
        return;
      }

      if (oeeFormState.availabilityWarning) {
        showToast('‚ö†Ô∏è Total downtime melebihi sisa waktu! Cek data availability Anda', 'error');
        return;
      }

      const allPackerNames = oeeFormState.packerMeters.flatMap(m => m.packers.map(p => p.packerName)).join(', ');
      const produkBatch = oeeFormState.packerMeters.map(m => {
        const prod = localData.produk.find(p => p.id === m.productId);
        return `${prod?.nama}(${m.batchNumber})`;
      }).join(' | ');

      // Compile line stop mesin data
      const lsmData = oeeFormState.lineStopMesin
        .filter(lsm => parseFloat(lsm.durasi) > 0)
        .map(lsm => `${lsm.nama} (${lsm.durasi}min) - Action: ${lsm.action || '-'} - WR: ${lsm.wr || '-'}`)
        .join(' | ');

      // Compile line stop non-mesin data
      const lsnmData = oeeFormState.lineStopNonMesin
        .filter(lsnm => lsnm.checked && parseFloat(lsnm.durasi) > 0)
        .map(lsnm => `${lsnm.nama} (${lsnm.durasi}min) - Action: ${lsnm.action || '-'}`)
        .join(' | ');

      const record = {
        date,
        shift,
        product: produkBatch,
        packers: allPackerNames,
        output_actual: oeeFormState.results.totalOutput,
        availability_actual: parseFloat(oeeFormState.results.availabilityActual),
        performance: parseFloat(oeeFormState.results.performance),
        quality_rate: parseFloat(oeeFormState.results.qualityRate),
        oee_actual: parseFloat(oeeFormState.results.oeeActual),
        oee_365: parseFloat(oeeFormState.results.oee365),
        line_stop_mesin: lsmData || null,
        line_stop_non_mesin: lsnmData || null
      };

      try {
        const { error } = await supabaseClient.from('oee_records').insert([record]);
        if (error) throw error;

        localData.oee_records.unshift(record);
        await addAuditLog('INPUT OEE', `${produkBatch} - Packer: ${allPackerNames}`);
        showToast('Data OEE berhasil disimpan ÔøΩÔøΩ', 'success');
        resetOEEForm();
        updateDashboard();
      } catch (error) {
        console.error('Error saving OEE:', error);
        showToast('Gagal menyimpan data OEE', 'error');
      }
    }

    function resetOEEForm() {
      document.getElementById('form-oee').reset();
      document.getElementById('oee-date').value = new Date().toISOString().split('T')[0];
      oeeFormState.shiftMinutes = 0;
      oeeFormState.packerMeters = [];
      oeeFormState.downtime = [];
      oeeFormState.lineStopMesin = [];
      oeeFormState.lineStopNonMesin = [];
      oeeFormState.minorStop = [];
      oeeFormState.results = {};
      document.getElementById('packer-meter-list').innerHTML = '';
      document.getElementById('odt-list').innerHTML = '';
      document.getElementById('line-stop-mesin-list').innerHTML = '';
      document.getElementById('line-stop-non-mesin-list').innerHTML = '';
      document.getElementById('minor-stop-list').innerHTML = '';
      document.getElementById('calc-availability-actual').textContent = '0%';
      document.getElementById('calc-performance').textContent = '0%';
      document.getElementById('calc-quality').textContent = '0%';
      document.getElementById('calc-oee-actual').textContent = '0%';
      document.getElementById('calc-oee-365').textContent = '0%';
      document.getElementById('calc-total-output').textContent = '0 DUS';
    }

    let dashboardCharts = {};
    let filteredOeeRecords = [];

    function initDashboardFilters() {
      populateFilterOptions();
      // Set default date range to current month (1st to last day)
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();
      
      // First day of current month (always 01)
      const startDate = new Date(currentYear, currentMonth, 1);
      
      // Last day of current month
      const endDate = new Date(currentYear, currentMonth + 1, 0);
      
      // Format as YYYY-MM-DD strings using local date (not UTC)
      const startString = String(startDate.getFullYear()).padStart(4, '0') + '-' + 
                         String(startDate.getMonth() + 1).padStart(2, '0') + '-' +
                         String(startDate.getDate()).padStart(2, '0');
      const endString = String(endDate.getFullYear()).padStart(4, '0') + '-' + 
                       String(endDate.getMonth() + 1).padStart(2, '0') + '-' +
                       String(endDate.getDate()).padStart(2, '0');
      
      document.getElementById('filter-date-start').value = startString;
      document.getElementById('filter-date-end').value = endString;
      
      // Apply filters immediately
      applyDashboardFilters();
    }

    function populateFilterOptions() {
      // Populate product filter
      const productSelect = document.getElementById('filter-product');
      const existingOptions = productSelect.querySelectorAll('option:not(:first-child)');
      existingOptions.forEach(opt => opt.remove());
      
      localData.produk.forEach(prod => {
        const option = document.createElement('option');
        option.value = prod.id;
        option.textContent = prod.nama;
        productSelect.appendChild(option);
      });

      // Populate packer filter
      const packerSelect = document.getElementById('filter-packer');
      const existingPackerOptions = packerSelect.querySelectorAll('option:not(:first-child)');
      existingPackerOptions.forEach(opt => opt.remove());
      
      localData.packer.forEach(pack => {
        const option = document.createElement('option');
        option.value = pack.nama;
        option.textContent = pack.nama;
        packerSelect.appendChild(option);
      });
    }

    function applyDashboardFilters() {
      const dateStart = document.getElementById('filter-date-start').value;
      const dateEnd = document.getElementById('filter-date-end').value;
      const selectedProduct = document.getElementById('filter-product').value;
      const selectedPacker = document.getElementById('filter-packer').value;

      filteredOeeRecords = localData.oee_records.filter(record => {
        const recordDate = record.date;
        
        // Date range filter
        if (dateStart && recordDate < dateStart) return false;
        if (dateEnd && recordDate > dateEnd) return false;

        // Product filter
        if (selectedProduct && !record.product.includes(selectedProduct)) return false;

        // Packer filter
        if (selectedPacker && !record.packers.includes(selectedPacker)) return false;

        return true;
      });

      updateDashboard();
    }

    function resetDashboardFilters() {
      document.getElementById('filter-date-start').value = '';
      document.getElementById('filter-date-end').value = '';
      document.getElementById('filter-product').value = '';
      document.getElementById('filter-packer').value = '';
      filteredOeeRecords = [...localData.oee_records];
      updateDashboard();
    }

    function updateDashboard() {
      updateDashboardData();
      renderCharts();
      renderPackerPerformance();
      renderOEEHistory();
    }

    function updateDashboardData() {
      const recordsToUse = filteredOeeRecords.length > 0 ? filteredOeeRecords : localData.oee_records;
      
      if (!recordsToUse || recordsToUse.length === 0) {
        document.getElementById('score-oee-actual').textContent = '0%';
        document.getElementById('score-oee-365').textContent = '0%';
        document.getElementById('score-total-output').textContent = '0';
        updateScoreCardColors(0, 0);
        return;
      }

      let sumOeeActual = 0, countOeeActual = 0;
      let sumOee365 = 0, countOee365 = 0;
      let totalOutput = 0;

      recordsToUse.forEach(r => {
        const oeeActual = parseFloat(r.oee_actual) || 0;
        const oee365 = parseFloat(r.oee_365) || 0;
        const output = parseFloat(r.output_actual) || 0;

        if (oeeActual > 0) { 
          sumOeeActual += oeeActual; 
          countOeeActual++; 
        }
        if (oee365 > 0) { 
          sumOee365 += oee365; 
          countOee365++; 
        }
        totalOutput += output;
      });

      const avgOeeActual = countOeeActual > 0 ? sumOeeActual / countOeeActual : 0;
      const avgOee365 = countOee365 > 0 ? sumOee365 / countOee365 : 0;

      document.getElementById('score-oee-actual').textContent = `${avgOeeActual.toFixed(1)}%`;
      document.getElementById('score-oee-365').textContent = `${avgOee365.toFixed(1)}%`;
      document.getElementById('score-total-output').textContent = totalOutput.toLocaleString('id-ID');

      updateScoreCardColors(avgOeeActual, avgOee365);
    }

    function updateScoreCardColors(oeeActual, oee365) {
      const cardActual = document.getElementById('score-card-oee-actual');
      const card365 = document.getElementById('score-card-oee-365');

      if (cardActual) {
        if (oeeActual < 88) {
          cardActual.style.background = 'linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%)';
          cardActual.style.borderColor = '#ef4444';
        } else {
          cardActual.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #f0fdf4 100%)';
          cardActual.style.borderColor = '#10b981';
        }
      }

      if (card365) {
        if (oee365 < 55) {
          card365.style.background = 'linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%)';
          card365.style.borderColor = '#ef4444';
        } else {
          card365.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #f0fdf4 100%)';
          card365.style.borderColor = '#10b981';
        }
      }
    }

    function renderCharts() {
      renderOEEMonthlyChart();
      renderOEEDailyChart();
      renderAPQABreakdownChart();
      renderODTTop10Chart();
      renderLineStopMesinTop10Chart();
      renderLineStopNonMesinTop10Chart();
      renderMinorStopTop10Chart();
    }

    function renderOEEMonthlyChart() {
      const monthlyData = {};
      
      // Hardcoded: Jan 2026 sampai Des 2026
      for (let month = 1; month <= 12; month++) {
        const yearMonth = '2026-' + String(month).padStart(2, '0');
        monthlyData[yearMonth] = [];
      }

      const recordsToUse = filteredOeeRecords.length > 0 ? filteredOeeRecords : localData.oee_records;
      recordsToUse.forEach(r => {
        const yearMonth = r.date.substring(0, 7);
        if (monthlyData[yearMonth]) {
          const val = parseFloat(r.oee_actual) || 0;
          if (val > 0) monthlyData[yearMonth].push(val);
        }
      });

      const labels = Object.keys(monthlyData).map(ym => {
        const [year, month] = ym.split('-');
        const date = new Date(year, month - 1);
        return date.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' });
      });

      const data = Object.values(monthlyData).map(arr => 
        arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0
      );

      const ctx = document.getElementById('chart-oee-monthly').getContext('2d');
      if (dashboardCharts.oeeMonthly) dashboardCharts.oeeMonthly.destroy();
      
      dashboardCharts.oeeMonthly = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'OEE Actual %',
            data: data,
            borderColor: '#ec4899',
            backgroundColor: 'rgba(236, 72, 153, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointBackgroundColor: '#ec4899'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
        }
      });
    }

    function renderOEEDailyChart() {
      const dailyData = {};
      
      // Get current month's first and last day
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      
      // Create entries for all days in current month (01 to last day)
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        dailyData[dateStr] = [];
      }

      const recordsToUse = filteredOeeRecords.length > 0 ? filteredOeeRecords : localData.oee_records;
      recordsToUse.forEach(r => {
        if (dailyData[r.date] !== undefined) {
          const val = parseFloat(r.oee_actual) || 0;
          if (val > 0) dailyData[r.date].push(val);
        }
      });

      const labels = Object.keys(dailyData).map(d => 
        new Date(d + 'T00:00:00').toLocaleDateString('id-ID', { day: '2-digit', month: 'short' })
      );

      const data = Object.values(dailyData).map(arr => 
        arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0
      );

      const ctx = document.getElementById('chart-oee-daily').getContext('2d');
      if (dashboardCharts.oeeDaily) dashboardCharts.oeeDaily.destroy();
      
      dashboardCharts.oeeDaily = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'OEE Actual %',
            data: data,
            borderColor: '#a855f7',
            backgroundColor: 'rgba(168, 85, 247, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: '#a855f7'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
        }
      });
    }

    function renderAPQABreakdownChart() {
      const recordsToUse = filteredOeeRecords.length > 0 ? filteredOeeRecords : localData.oee_records;
      if (!recordsToUse || recordsToUse.length === 0) return;

      let sumAvailActual = 0, countAvailActual = 0;
      let sumPerf = 0, countPerf = 0;
      let sumQual = 0, countQual = 0;
      let sumAvail365 = 0, countAvail365 = 0;

      recordsToUse.forEach(r => {
        const availActual = parseFloat(r.availability_actual) || 0;
        const perf = parseFloat(r.performance) || 0;
        const qual = parseFloat(r.quality_rate) || 0;

        if (availActual > 0) { sumAvailActual += availActual; countAvailActual++; }
        if (perf > 0) { sumPerf += perf; countPerf++; }
        if (qual > 0) { sumQual += qual; countQual++; }
        
        sumAvail365 += 100;
        countAvail365++;
      });

      const ctx = document.getElementById('chart-apqa-breakdown').getContext('2d');
      if (dashboardCharts.apqa) dashboardCharts.apqa.destroy();
      
      dashboardCharts.apqa = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Availability Actual', 'Performance', 'Quality Rate', 'Availability 365'],
          datasets: [{
            label: '%',
            data: [
              countAvailActual > 0 ? sumAvailActual / countAvailActual : 0,
              countPerf > 0 ? sumPerf / countPerf : 0,
              countQual > 0 ? sumQual / countQual : 0,
              countAvail365 > 0 ? sumAvail365 / countAvail365 : 0
            ],
            backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b'],
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: { x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
        },
        plugins: [{
          id: 'chartAreaPlugin',
          afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            chart.data.datasets.forEach((dataset, datasetIndex) => {
              chart.getDatasetMeta(datasetIndex).data.forEach((datapoint, index) => {
                const { x, y } = datapoint.tooltipPosition();
                const value = dataset.data[index];
                
                ctx.font = 'bold 13px Segoe UI';
                ctx.fillStyle = '#000';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText(value.toFixed(1) + '%', x - 8, y);
              });
            });
          }
        }]
      });
    }

    function getTopDowntimeData(type) {
      const downtimeMap = {};

      localData.oee_records.forEach(r => {
        const recordDate = r.date;
        const recordShift = r.shift;
        const key = `${recordDate}-${recordShift}`;

        if (type === 'odt') {
          localData.downtime.forEach(odt => {
            const downtimeKey = `${odt.nama}_${key}`;
            if (!downtimeMap[downtimeKey]) {
              downtimeMap[downtimeKey] = { name: odt.nama, durasi: 0 };
            }
          });
        }
      });

      return Object.values(downtimeMap)
        .sort((a, b) => b.durasi - a.durasi)
        .slice(0, 10);
    }

    function renderODTTop10Chart() {
      const downtimeMap = {};

      localData.oee_records.forEach(r => {
        localData.downtime.forEach(odt => {
          if (!downtimeMap[odt.nama]) {
            downtimeMap[odt.nama] = 0;
          }
          downtimeMap[odt.nama] += odt.waktu_standard || 0;
        });
      });

      const sortedData = Object.entries(downtimeMap)
        .map(([nama, durasi]) => ({ nama, durasi }))
        .sort((a, b) => b.durasi - a.durasi)
        .slice(0, 10);

      const labels = sortedData.map(d => d.nama);
      const data = sortedData.map(d => d.durasi);

      const ctx = document.getElementById('chart-odt-top10').getContext('2d');
      if (dashboardCharts.odtTop10) dashboardCharts.odtTop10.destroy();
      
      dashboardCharts.odtTop10 = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Menit',
            data: data,
            backgroundColor: '#3b82f6',
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        },
        plugins: [{
          id: 'chartAreaPlugin',
          afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            chart.data.datasets.forEach((dataset, datasetIndex) => {
              chart.getDatasetMeta(datasetIndex).data.forEach((datapoint, index) => {
                const { x, y } = datapoint.tooltipPosition();
                const value = dataset.data[index];
                
                ctx.font = 'bold 12px Segoe UI';
                ctx.fillStyle = '#000';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText(value.toFixed(0) + 'min', x - 8, y);
              });
            });
          }
        }]
      });
    }

    function renderLineStopMesinTop10Chart() {
      const lsmMap = {};

      localData.oee_records.forEach(r => {
        localData.line_stop_mesin.forEach(lsm => {
          if (!lsmMap[lsm.nama]) {
            lsmMap[lsm.nama] = 0;
          }
        });
      });

      const sortedData = Object.entries(lsmMap)
        .map(([nama, durasi]) => ({ nama, durasi }))
        .sort((a, b) => b.durasi - a.durasi)
        .slice(0, 10);

      const labels = sortedData.map(d => d.nama);
      const data = sortedData.map(d => d.durasi);

      const ctx = document.getElementById('chart-lsm-top10').getContext('2d');
      if (dashboardCharts.lsmTop10) dashboardCharts.lsmTop10.destroy();
      
      dashboardCharts.lsmTop10 = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Menit',
            data: data,
            backgroundColor: '#8b5cf6',
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        },
        plugins: [{
          id: 'chartAreaPlugin',
          afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            chart.data.datasets.forEach((dataset, datasetIndex) => {
              chart.getDatasetMeta(datasetIndex).data.forEach((datapoint, index) => {
                const { x, y } = datapoint.tooltipPosition();
                const value = dataset.data[index];
                
                ctx.font = 'bold 12px Segoe UI';
                ctx.fillStyle = '#000';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText(value.toFixed(0) + 'min', x - 8, y);
              });
            });
          }
        }]
      });
    }

    function renderLineStopNonMesinTop10Chart() {
      const lsnmMap = {};

      localData.oee_records.forEach(r => {
        localData.line_stop_non_mesin.forEach(lsnm => {
          if (!lsnmMap[lsnm.nama]) {
            lsnmMap[lsnm.nama] = 0;
          }
        });
      });

      const sortedData = Object.entries(lsnmMap)
        .map(([nama, durasi]) => ({ nama, durasi }))
        .sort((a, b) => b.durasi - a.durasi)
        .slice(0, 10);

      const labels = sortedData.map(d => d.nama);
      const data = sortedData.map(d => d.durasi);

      const ctx = document.getElementById('chart-lsnm-top10').getContext('2d');
      if (dashboardCharts.lsnmTop10) dashboardCharts.lsnmTop10.destroy();
      
      dashboardCharts.lsnmTop10 = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Menit',
            data: data,
            backgroundColor: '#10b981',
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        },
        plugins: [{
          id: 'chartAreaPlugin',
          afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            chart.data.datasets.forEach((dataset, datasetIndex) => {
              chart.getDatasetMeta(datasetIndex).data.forEach((datapoint, index) => {
                const { x, y } = datapoint.tooltipPosition();
                const value = dataset.data[index];
                
                ctx.font = 'bold 12px Segoe UI';
                ctx.fillStyle = '#000';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText(value.toFixed(0) + 'min', x - 8, y);
              });
            });
          }
        }]
      });
    }

    function renderMinorStopTop10Chart() {
      const msMap = {};

      localData.oee_records.forEach(r => {
        localData.minor_stop.forEach(ms => {
          if (!msMap[ms.nama]) {
            msMap[ms.nama] = 0;
          }
        });
      });

      const sortedData = Object.entries(msMap)
        .map(([nama, durasi]) => ({ nama, durasi }))
        .sort((a, b) => b.durasi - a.durasi)
        .slice(0, 10);

      const labels = sortedData.map(d => d.nama);
      const data = sortedData.map(d => d.durasi);

      const ctx = document.getElementById('chart-ms-top10').getContext('2d');
      if (dashboardCharts.msTop10) dashboardCharts.msTop10.destroy();
      
      dashboardCharts.msTop10 = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Menit',
            data: data,
            backgroundColor: '#f59e0b',
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        },
        plugins: [{
          id: 'chartAreaPlugin',
          afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            chart.data.datasets.forEach((dataset, datasetIndex) => {
              chart.getDatasetMeta(datasetIndex).data.forEach((datapoint, index) => {
                const { x, y } = datapoint.tooltipPosition();
                const value = dataset.data[index];
                
                ctx.font = 'bold 12px Segoe UI';
                ctx.fillStyle = '#000';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText(value.toFixed(0) + 'min', x - 8, y);
              });
            });
          }
        }]
      });
    }

    function renderPackerPerformance() {
      const packerMap = {};
      
      const recordsToUse = filteredOeeRecords.length > 0 ? filteredOeeRecords : localData.oee_records;
      recordsToUse.forEach(r => {
        const packers = r.packers?.split(', ') || [];
        packers.forEach(packer => {
          if (!packer) return;
          if (!packerMap[packer]) {
            packerMap[packer] = { nama: packer, oeeValues: [], totalOutput: 0, records: 0 };
          }
          
          const oeeVal = parseFloat(r.oee_actual) || 0;
          if (oeeVal > 0) packerMap[packer].oeeValues.push(oeeVal);
          
          packerMap[packer].totalOutput += parseFloat(r.output_actual) || 0;
          packerMap[packer].records += 1;
        });
      });

      const performanceData = Object.values(packerMap).sort((a, b) => {
        const avgA = a.oeeValues.length > 0 ? a.oeeValues.reduce((x, y) => x + y, 0) / a.oeeValues.length : 0;
        const avgB = b.oeeValues.length > 0 ? b.oeeValues.reduce((x, y) => x + y, 0) / b.oeeValues.length : 0;
        return avgB - avgA;
      });
      
      const tbody = document.getElementById('table-packer-performance');
      if (performanceData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-400 py-8">Belum ada data</td></tr>';
        return;
      }

      tbody.innerHTML = performanceData.map((p, idx) => {
        const avgOEE = p.oeeValues.length > 0 ? p.oeeValues.reduce((a, b) => a + b, 0) / p.oeeValues.length : 0;
        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${p.nama}</td>
            <td>${avgOEE.toFixed(1)}%</td>
            <td>${p.totalOutput.toLocaleString('id-ID', { maximumFractionDigits: 1 })}</td>
            <td>${p.records}</td>
          </tr>
        `;
      }).join('');
    }

    function renderOEEHistory() {
      const tbody = document.getElementById('table-oee-history');
      const recordsToUse = filteredOeeRecords.length > 0 ? filteredOeeRecords : localData.oee_records;
      
      if (!recordsToUse || recordsToUse.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-400 py-8">Belum ada data</td></tr>';
        return;
      }

      tbody.innerHTML = recordsToUse.slice(0, 50).map(r => `
        <tr>
          <td>${r.date}</td>
          <td>${r.shift}</td>
          <td>${r.product || '-'}</td>
          <td><strong>${parseFloat(r.oee_actual).toFixed(1)}%</strong></td>
          <td>${parseFloat(r.oee_365).toFixed(1)}%</td>
          <td style="font-size: 12px; max-width: 200px;">${r.line_stop_mesin ? r.line_stop_mesin.substring(0, 100) + (r.line_stop_mesin.length > 100 ? '...' : '') : '-'}</td>
          <td style="font-size: 12px;">-</td>
          <td style="font-size: 12px; max-width: 200px;">${r.line_stop_non_mesin ? r.line_stop_non_mesin.substring(0, 100) + (r.line_stop_non_mesin.length > 100 ? '...' : '') : '-'}</td>
          <td style="font-size: 12px;">-</td>
        </tr>
      `).join('');
    }

    function renderMasterDataLists() {
      renderProductList();
      renderPackerList();
      renderODTList_Master();
      renderLineStopMesinMaster();
      renderLineStopNonMesinMaster();
      renderMinorStopMaster();
    }

    function renderProductList() {
      const listDiv = document.getElementById('product-list');
      listDiv.innerHTML = localData.produk.map(p => `
        <div class="master-card" id="card-prod-${p.id}">
          <div class="master-card-content">
            <p class="master-card-name">${p.nama}</p>
            <p class="master-card-detail">Target: ${p.target} DUS/menit</p>
          </div>
          <div class="master-card-actions">
            <button class="btn-edit" onclick="editProduct('${p.id}')">Edit</button>
            <button class="btn-delete" id="del-btn-prod-${p.id}" onclick="showDeleteConfirm('${p.id}', 'produk', '${p.nama}')">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function renderPackerList() {
      const listDiv = document.getElementById('packer-list');
      listDiv.innerHTML = localData.packer.map(p => `
        <div class="master-card" id="card-pack-${p.id}">
          <div class="master-card-content">
            <p class="master-card-name">${p.nama}</p>
          </div>
          <div class="master-card-actions">
            <button class="btn-edit" onclick="editPacker('${p.id}')">Edit</button>
            <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'packer', '${p.nama}')">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function renderODTList_Master() {
      const listDiv = document.getElementById('odt-master-list');
      listDiv.innerHTML = localData.downtime.map(p => `
        <div class="master-card" id="card-odt-${p.id}">
          <div class="master-card-content">
            <p class="master-card-name">${p.nama}</p>
            <p class="master-card-detail">Std: ${p.waktu_standard} menit</p>
          </div>
          <div class="master-card-actions">
            <button class="btn-edit" onclick="editODT('${p.id}')">Edit</button>
            <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'odt', '${p.nama}')">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function renderLineStopMesinMaster() {
      const listDiv = document.getElementById('line-stop-mesin-master-list');
      listDiv.innerHTML = localData.line_stop_mesin.map(p => `
        <div class="master-card" id="card-lsm-${p.id}">
          <div class="master-card-content">
            <p class="master-card-name">${p.nama}</p>
          </div>
          <div class="master-card-actions">
            <button class="btn-edit" onclick="editLineStopMesin('${p.id}')">Edit</button>
            <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'lsm', '${p.nama}')">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function renderLineStopNonMesinMaster() {
      const listDiv = document.getElementById('line-stop-non-mesin-master-list');
      listDiv.innerHTML = localData.line_stop_non_mesin.map(p => `
        <div class="master-card" id="card-lsnm-${p.id}">
          <div class="master-card-content">
            <p class="master-card-name">${p.nama}</p>
          </div>
          <div class="master-card-actions">
            <button class="btn-edit" onclick="editLineStopNonMesin('${p.id}')">Edit</button>
            <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'lsnm', '${p.nama}')">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function renderMinorStopMaster() {
      const listDiv = document.getElementById('minor-stop-master-list');
      listDiv.innerHTML = localData.minor_stop.map(p => `
        <div class="master-card" id="card-ms-${p.id}">
          <div class="master-card-content">
            <p class="master-card-name">${p.nama}</p>
          </div>
          <div class="master-card-actions">
            <button class="btn-edit" onclick="editMinorStop('${p.id}')">Edit</button>
            <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'minor_stop', '${p.nama}')">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    // Modal Management
    let currentModalAction = null;
    let currentEditId = null;

    function openModal(title, fields, onSubmit) {
      document.getElementById('modal-title').textContent = title;
      const fieldsDiv = document.getElementById('modal-fields');
      fieldsDiv.innerHTML = fields.map(f => `
        <div class="form-group" style="margin-bottom: 16px;">
          <label>${f.label}</label>
          <input type="text" id="modal-field-${f.name}" class="input-field" placeholder="${f.placeholder}" value="${f.value || ''}">
        </div>
      `).join('');
      
      currentModalAction = onSubmit;
      document.getElementById('modal-backdrop').style.display = 'block';
      document.getElementById('modal').style.display = 'block';
      document.getElementById('modal-field-' + fields[0].name).focus();
    }

    function closeModal() {
      document.getElementById('modal-backdrop').style.display = 'none';
      document.getElementById('modal').style.display = 'none';
      currentModalAction = null;
      currentEditId = null;
    }

    function submitModalForm(event) {
      event.preventDefault();
      if (currentModalAction) {
        const values = {};
        const inputs = document.querySelectorAll('#modal-fields input');
        inputs.forEach(input => {
          const fieldId = input.id;
          const fieldName = fieldId.replace('modal-field-', '');
          values[fieldName] = input.value;
        });
        currentModalAction(values);
        closeModal();
      }
    }

    // Master Data CRUD Functions
    function openAddProductModal() {
      openModal('Tambah Produk', [
        { name: 'nama', label: 'Nama Produk', placeholder: 'Masukkan nama produk', value: '' },
        { name: 'target', label: 'Target (DUS/menit)', placeholder: 'Masukkan target', value: '' }
      ], async (values) => {
        if (!values.nama.trim() || !values.target.trim()) {
          showToast('Semua field wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('produk').insert([{
            nama: values.nama.trim(),
            target: parseFloat(values.target) || 0
          }]);
          if (error) throw error;

          await loadDataFromSupabase();
          renderProductList();
          await addAuditLog('CREATE PRODUCT', values.nama);
          showToast('Produk berhasil ditambahkan ÔøΩÔøΩÔøΩ', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal menambahkan produk', 'error');
        }
      });
    }

    function editProduct(id) {
      const prod = localData.produk.find(p => p.id === id);
      if (!prod) return;

      currentEditId = id;
      openModal('Edit Produk', [
        { name: 'nama', label: 'Nama Produk', placeholder: 'Masukkan nama produk', value: prod.nama },
        { name: 'target', label: 'Target (DUS/menit)', placeholder: 'Masukkan target', value: prod.target }
      ], async (values) => {
        if (!values.nama.trim() || !values.target.trim()) {
          showToast('Semua field wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('produk').update({
            nama: values.nama.trim(),
            target: parseFloat(values.target) || 0
          }).eq('id', currentEditId);
          if (error) throw error;

          await loadDataFromSupabase();
          renderProductList();
          await addAuditLog('UPDATE PRODUCT', values.nama);
          showToast('Produk berhasil diperbarui ÔøΩÔøΩÔøΩ', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal memperbarui produk', 'error');
        }
      });
    }

    function openAddPackerModal() {
      openModal('Tambah Packer', [
        { name: 'nama', label: 'Nama Packer', placeholder: 'Masukkan nama packer', value: '' }
      ], async (values) => {
        if (!values.nama.trim()) {
          showToast('Nama packer wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('packer').insert([{
            nama: values.nama.trim()
          }]);
          if (error) throw error;

          await loadDataFromSupabase();
          renderPackerList();
          await addAuditLog('CREATE PACKER', values.nama);
          showToast('Packer berhasil ditambahkan ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal menambahkan packer', 'error');
        }
      });
    }

    function editPacker(id) {
      const pack = localData.packer.find(p => p.id === id);
      if (!pack) return;

      currentEditId = id;
      openModal('Edit Packer', [
        { name: 'nama', label: 'Nama Packer', placeholder: 'Masukkan nama packer', value: pack.nama }
      ], async (values) => {
        if (!values.nama.trim()) {
          showToast('Nama packer wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('packer').update({
            nama: values.nama.trim()
          }).eq('id', currentEditId);
          if (error) throw error;

          await loadDataFromSupabase();
          renderPackerList();
          await addAuditLog('UPDATE PACKER', values.nama);
          showToast('Packer berhasil diperbarui ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal memperbarui packer', 'error');
        }
      });
    }

    function openAddODTModal() {
      openModal('Tambah ODT', [
        { name: 'nama', label: 'Nama ODT', placeholder: 'Masukkan nama ODT', value: '' },
        { name: 'waktu_standard', label: 'Waktu Standard (Menit)', placeholder: 'Masukkan waktu standard', value: '' }
      ], async (values) => {
        if (!values.nama.trim() || !values.waktu_standard.trim()) {
          showToast('Semua field wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('downtime').insert([{
            nama: values.nama.trim(),
            waktu_standard: parseFloat(values.waktu_standard) || 0
          }]);
          if (error) throw error;

          await loadDataFromSupabase();
          renderODTList_Master();
          await addAuditLog('CREATE ODT', values.nama);
          showToast('ODT berhasil ditambahkan ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal menambahkan ODT', 'error');
        }
      });
    }

    function editODT(id) {
      const odt = localData.downtime.find(p => p.id === id);
      if (!odt) return;

      currentEditId = id;
      openModal('Edit ODT', [
        { name: 'nama', label: 'Nama ODT', placeholder: 'Masukkan nama ODT', value: odt.nama },
        { name: 'waktu_standard', label: 'Waktu Standard (Menit)', placeholder: 'Masukkan waktu standard', value: odt.waktu_standard }
      ], async (values) => {
        if (!values.nama.trim() || !values.waktu_standard.trim()) {
          showToast('Semua field wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('downtime').update({
            nama: values.nama.trim(),
            waktu_standard: parseFloat(values.waktu_standard) || 0
          }).eq('id', currentEditId);
          if (error) throw error;

          await loadDataFromSupabase();
          renderODTList_Master();
          await addAuditLog('UPDATE ODT', values.nama);
          showToast('ODT berhasil diperbarui ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal memperbarui ODT', 'error');
        }
      });
    }

    function openAddLineStopMesinModal() {
      openModal('Tambah Line Stop Mesin', [
        { name: 'nama', label: 'Nama Line Stop', placeholder: 'Masukkan nama line stop', value: '' }
      ], async (values) => {
        if (!values.nama.trim()) {
          showToast('Nama line stop wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('line_stop_mesin').insert([{
            nama: values.nama.trim()
          }]);
          if (error) throw error;

          await loadDataFromSupabase();
          renderLineStopMesinMaster();
          await addAuditLog('CREATE LINE STOP MESIN', values.nama);
          showToast('Line stop mesin berhasil ditambahkan ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal menambahkan line stop mesin', 'error');
        }
      });
    }

    function editLineStopMesin(id) {
      const lsm = localData.line_stop_mesin.find(p => p.id === id);
      if (!lsm) return;

      currentEditId = id;
      openModal('Edit Line Stop Mesin', [
        { name: 'nama', label: 'Nama Line Stop', placeholder: 'Masukkan nama line stop', value: lsm.nama }
      ], async (values) => {
        if (!values.nama.trim()) {
          showToast('Nama line stop wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('line_stop_mesin').update({
            nama: values.nama.trim()
          }).eq('id', currentEditId);
          if (error) throw error;

          await loadDataFromSupabase();
          renderLineStopMesinMaster();
          await addAuditLog('UPDATE LINE STOP MESIN', values.nama);
          showToast('Line stop mesin berhasil diperbarui ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal memperbarui line stop mesin', 'error');
        }
      });
    }

    function openAddLineStopNonMesinModal() {
      openModal('Tambah Line Stop Non-Mesin', [
        { name: 'nama', label: 'Nama Line Stop', placeholder: 'Masukkan nama line stop', value: '' }
      ], async (values) => {
        if (!values.nama.trim()) {
          showToast('Nama line stop wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('line_stop_non_mesin').insert([{
            nama: values.nama.trim()
          }]);
          if (error) throw error;

          await loadDataFromSupabase();
          renderLineStopNonMesinMaster();
          await addAuditLog('CREATE LINE STOP NON-MESIN', values.nama);
          showToast('Line stop non-mesin berhasil ditambahkan ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal menambahkan line stop non-mesin', 'error');
        }
      });
    }

    function editLineStopNonMesin(id) {
      const lsnm = localData.line_stop_non_mesin.find(p => p.id === id);
      if (!lsnm) return;

      currentEditId = id;
      openModal('Edit Line Stop Non-Mesin', [
        { name: 'nama', label: 'Nama Line Stop', placeholder: 'Masukkan nama line stop', value: lsnm.nama }
      ], async (values) => {
        if (!values.nama.trim()) {
          showToast('Nama line stop wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('line_stop_non_mesin').update({
            nama: values.nama.trim()
          }).eq('id', currentEditId);
          if (error) throw error;

          await loadDataFromSupabase();
          renderLineStopNonMesinMaster();
          await addAuditLog('UPDATE LINE STOP NON-MESIN', values.nama);
          showToast('Line stop non-mesin berhasil diperbarui ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal memperbarui line stop non-mesin', 'error');
        }
      });
    }

    function openAddMinorStopModal() {
      openModal('Tambah Minor Stop', [
        { name: 'nama', label: 'Nama Minor Stop', placeholder: 'Masukkan nama minor stop', value: '' }
      ], async (values) => {
        if (!values.nama.trim()) {
          showToast('Nama minor stop wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('minor_stop').insert([{
            nama: values.nama.trim()
          }]);
          if (error) throw error;

          await loadDataFromSupabase();
          renderMinorStopMaster();
          await addAuditLog('CREATE MINOR STOP', values.nama);
          showToast('Minor stop berhasil ditambahkan ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal menambahkan minor stop', 'error');
        }
      });
    }

    function editMinorStop(id) {
      const ms = localData.minor_stop.find(p => p.id === id);
      if (!ms) return;

      currentEditId = id;
      openModal('Edit Minor Stop', [
        { name: 'nama', label: 'Nama Minor Stop', placeholder: 'Masukkan nama minor stop', value: ms.nama }
      ], async (values) => {
        if (!values.nama.trim()) {
          showToast('Nama minor stop wajib diisi', 'error');
          return;
        }

        try {
          const { error } = await supabaseClient.from('minor_stop').update({
            nama: values.nama.trim()
          }).eq('id', currentEditId);
          if (error) throw error;

          await loadDataFromSupabase();
          renderMinorStopMaster();
          await addAuditLog('UPDATE MINOR STOP', values.nama);
          showToast('Minor stop berhasil diperbarui ‚ú®', 'success');
        } catch (error) {
          console.error('Error:', error);
          showToast('Gagal memperbarui minor stop', 'error');
        }
      });
    }

    async function deleteProduct(id) {
      try {
        const { error } = await supabaseClient.from('produk').delete().eq('id', id);
        if (error) throw error;
        await loadDataFromSupabase();
        renderProductList();
        await addAuditLog('DELETE PRODUCT', 'Produk dihapus');
        showToast('Produk berhasil dihapus', 'success');
      } catch (error) {
        console.error('Error:', error);
        showToast('Gagal menghapus produk', 'error');
      }
    }

    async function deletePacker(id) {
      try {
        const { error } = await supabaseClient.from('packer').delete().eq('id', id);
        if (error) throw error;
        await loadDataFromSupabase();
        renderPackerList();
        await addAuditLog('DELETE PACKER', 'Packer dihapus');
        showToast('Packer berhasil dihapus', 'success');
      } catch (error) {
        console.error('Error:', error);
        showToast('Gagal menghapus packer', 'error');
      }
    }

    async function deleteODT(id) {
      try {
        const { error } = await supabaseClient.from('downtime').delete().eq('id', id);
        if (error) throw error;
        await loadDataFromSupabase();
        renderODTList_Master();
        await addAuditLog('DELETE ODT', 'ODT dihapus');
        showToast('ODT berhasil dihapus', 'success');
      } catch (error) {
        console.error('Error:', error);
        showToast('Gagal menghapus ODT', 'error');
      }
    }

    async function deleteLineStopMesin(id) {
      try {
        const { error } = await supabaseClient.from('line_stop_mesin').delete().eq('id', id);
        if (error) throw error;
        await loadDataFromSupabase();
        renderLineStopMesinMaster();
        await addAuditLog('DELETE LINE STOP MESIN', 'Line Stop dihapus');
        showToast('Line stop mesin berhasil dihapus', 'success');
      } catch (error) {
        console.error('Error:', error);
        showToast('Gagal menghapus line stop mesin', 'error');
      }
    }

    async function deleteLineStopNonMesin(id) {
      try {
        const { error } = await supabaseClient.from('line_stop_non_mesin').delete().eq('id', id);
        if (error) throw error;
        await loadDataFromSupabase();
        renderLineStopNonMesinMaster();
        await addAuditLog('DELETE LINE STOP NON-MESIN', 'Line Stop dihapus');
        showToast('Line stop non-mesin berhasil dihapus', 'success');
      } catch (error) {
        console.error('Error:', error);
        showToast('Gagal menghapus line stop non-mesin', 'error');
      }
    }

    async function deleteMinorStop(id) {
      try {
        const { error } = await supabaseClient.from('minor_stop').delete().eq('id', id);
        if (error) throw error;
        await loadDataFromSupabase();
        renderMinorStopMaster();
        await addAuditLog('DELETE MINOR STOP', 'Minor Stop dihapus');
        showToast('Minor stop berhasil dihapus', 'success');
      } catch (error) {
        console.error('Error:', error);
        showToast('Gagal menghapus minor stop', 'error');
      }
    }

    function showDeleteConfirm(id, type, nama) {
      const confirmBox = document.createElement('div');
      confirmBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 32px; z-index: 10000; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); min-width: 350px;';
      confirmBox.innerHTML = `
        <h3 style="margin: 0 0 16px 0; color: #ec4899; font-size: 18px; font-weight: 700;">Hapus Data?</h3>
        <p style="margin: 0 0 24px 0; color: #6b4c5c; font-size: 14px;">Yakin ingin menghapus <strong>"${nama}"</strong>? Tindakan ini tidak bisa dibatalkan.</p>
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-danger" style="flex: 1; margin: 0;" onclick="confirmDelete('${id}', '${type}'); document.querySelector('[data-confirm-box]').remove();">Hapus</button>
          <button class="btn btn-secondary" style="flex: 1; margin: 0;" onclick="document.querySelector('[data-confirm-box]').remove();">Batal</button>
        </div>
      `;
      confirmBox.setAttribute('data-confirm-box', 'true');

      const backdrop = document.createElement('div');
      backdrop.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999;';
      backdrop.onclick = () => {
        confirmBox.remove();
        backdrop.remove();
      };

      document.body.appendChild(backdrop);
      document.body.appendChild(confirmBox);
    }

    function confirmDelete(id, type) {
      if (type === 'produk') deleteProduct(id);
      else if (type === 'packer') deletePacker(id);
      else if (type === 'odt') deleteODT(id);
      else if (type === 'lsm') deleteLineStopMesin(id);
      else if (type === 'lsnm') deleteLineStopNonMesin(id);
      else if (type === 'minor_stop') deleteMinorStop(id);
    }

    function renderAuditTable() {
      const tbody = document.getElementById('audit-table');
      if (localData.audit_trail.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-8">Belum ada aktivitas</td></tr>';
        return;
      }

      tbody.innerHTML = localData.audit_trail.map(log => {
        const date = new Date(log.timestamp);
        return `
          <tr>
            <td>${date.toLocaleString('id-ID')}</td>
            <td>${log.activity}</td>
            <td>${log.detail}</td>
          </tr>
        `;
      }).join('');
    }

    async function addAuditLog(activity, detail) {
      try {
        const { error } = await supabaseClient.from('audit_trail').insert([{
          activity,
          detail
        }]);
        if (error) throw error;
        await loadDataFromSupabase();
        renderAuditTable();
      } catch (error) {
        console.error('Error adding audit log:', error);
      }
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }

    // Dark Mode Toggle
    function toggleDarkMode() {
      const isDarkMode = document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      updateModeToggleButton();
    }

    function updateModeToggleButton() {
      const isDarkMode = document.body.classList.contains('dark-mode');
      document.getElementById('mode-icon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
      document.getElementById('mode-text').textContent = isDarkMode ? 'Light' : 'Dark';
    }

    function initDarkMode() {
      const darkMode = localStorage.getItem('darkMode') === 'true';
      if (darkMode) {
        document.body.classList.add('dark-mode');
      }
      updateModeToggleButton();
    }

    // Update Clock and Date
    function updateClock() {
      const now = new Date();
      
      // Format time HH:MM:SS
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`;
      
      // Format date
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dateString = now.toLocaleDateString('id-ID', dateOptions);
      document.getElementById('current-date').textContent = dateString;
    }

    // Initialize dark mode on page load
    initDarkMode();
    
    // Update clock immediately and then every second
    updateClock();
    setInterval(updateClock, 1000);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cc288a771ac9b07',t:'MTc3MDc5OTE0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
