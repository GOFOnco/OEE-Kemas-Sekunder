<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>OEE KEMAS SEKUNDER SYSTEM</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ==================== RESET & VARIABLES ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #ec4899;
      --primary-dark: #be185d;
      --primary-light: #fbcfe8;
      --secondary: #a855f7;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gray: #9ca3af;
      --dark: #1f1729;
      --light: #fef3f8;
      --text-dark: #4a3f47;
      --text-light: #e5e5e5;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --box-shadow: 0 4px 16px rgba(236, 72, 153, 0.08);
      --transition: all 0.3s ease;
    }

    body {
      font-family: 'Segoe UI', 'Trebuchet MS', sans-serif;
      background: linear-gradient(135deg, #fef3f8 0%, #fce7f3 50%, #f5e6f0 100%);
      color: var(--text-dark);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ==================== TYPOGRAPHY - SEMUA UPPERCASE ==================== */
    h1, h2, h3, h4, h5, h6, p, span, div, label, button, input, select, textarea, th, td, option, .btn, .section-title, .chart-title, .score-label, .master-card-name, .master-card-detail, .empty-state-text, .toast, .warning-title, .warning-text, .login-title, .login-label, .login-error {
      text-transform: uppercase !important;
    }

    input::placeholder, textarea::placeholder {
      text-transform: uppercase !important;
      opacity: 0.7;
      font-size: 11px;
    }

    /* ==================== HEADER ==================== */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, #d946a6 50%, var(--primary-dark) 100%);
      color: white;
      padding: 12px 16px;
      box-shadow: 0 8px 24px rgba(236, 72, 153, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      flex: 1;
      text-align: center;
      min-width: 180px;
    }

    .header h1 {
      margin: 0;
      font-size: clamp(16px, 5vw, 24px);
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .header p {
      margin: 4px 0 0;
      font-size: clamp(9px, 2vw, 11px);
      opacity: 0.95;
    }

    .header-datetime {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: clamp(10px, 2vw, 12px);
      font-weight: 600;
      text-align: right;
      white-space: nowrap;
    }

    .header-datetime-time {
      font-size: clamp(12px, 3vw, 14px);
      font-weight: 700;
      font-family: 'Courier New', monospace;
    }

    .mode-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 12px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: clamp(11px, 2vw, 12px);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: var(--transition);
    }

    .mode-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .mode-toggle:active {
      transform: scale(0.98);
    }

    /* ==================== TABS ==================== */
    .tabs-container {
      display: flex;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-bottom: 2px solid rgba(236, 72, 153, 0.1);
      padding: 0 8px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      position: sticky;
      top: 76px;
      z-index: 99;
    }

    .tabs-container::-webkit-scrollbar {
      height: 3px;
    }

    .tabs-container::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    .tab-btn {
      background: none;
      border: none;
      color: #9ca3af;
      padding: 12px 16px;
      cursor: pointer;
      font-size: clamp(11px, 2vw, 13px);
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .tab-btn:hover {
      color: var(--primary);
    }

    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* ==================== CONTENT ==================== */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      -webkit-overflow-scrolling: touch;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ==================== FORM SECTIONS ==================== */
    .form-section {
      background: white;
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--box-shadow);
      border: 1px solid rgba(236, 72, 153, 0.1);
      transition: var(--transition);
    }

    .form-section:hover {
      box-shadow: 0 8px 24px rgba(236, 72, 153, 0.12);
    }

    .section-title {
      font-size: clamp(13px, 3vw, 15px);
      font-weight: 700;
      color: var(--primary);
      margin: 0 0 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      word-break: break-word;
    }

    .section-title::before {
      content: '';
      width: 3px;
      height: clamp(16px, 4vw, 18px);
      background: linear-gradient(180deg, var(--primary) 0%, #d946a6 100%);
      border-radius: 2px;
    }

    /* ==================== FORM GRID ==================== */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: clamp(10px, 2vw, 11px);
      font-weight: 600;
      color: #6b4c5c;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border: 2px solid #f3e8f0;
      border-radius: var(--border-radius-sm);
      font-size: clamp(12px, 2vw, 13px);
      font-family: inherit;
      transition: var(--transition);
      background: #faf9fb;
      color: var(--text-dark);
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      word-break: break-word;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }

    .form-group input[readonly] {
      background: #f3e8f0;
      color: var(--primary-dark);
      font-weight: bold;
    }

    /* ==================== BUTTONS ==================== */
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: var(--border-radius-sm);
      font-size: clamp(11px, 2vw, 12px);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
      min-width: 80px;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: clamp(10px, 1.5vw, 11px);
      min-width: 60px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, #d946a6 100%);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #d946a6 0%, var(--primary-dark) 100%);
    }

    .btn-secondary {
      background: var(--gray);
      color: white;
    }

    .btn-secondary:hover {
      background: #6b7280;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* ==================== SCORE CARDS ==================== */
    .score-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .score-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 16px 12px;
      text-align: center;
      box-shadow: var(--box-shadow);
      border: 1px solid rgba(236, 72, 153, 0.1);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      word-break: break-word;
    }

    .score-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(236, 72, 153, 0.15);
    }

    .score-label {
      font-size: clamp(10px, 2vw, 11px);
      color: #6b4c5c;
      font-weight: 600;
      margin-bottom: 8px;
      word-break: break-word;
    }

    .score-value {
      font-size: clamp(18px, 5vw, 28px);
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, #d946a6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
      word-break: break-word;
    }

    /* ==================== PACKER METER CARDS ==================== */
    .card {
      background: white;
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 16px;
      border: 2px solid rgba(236, 72, 153, 0.2);
      transition: var(--transition);
    }

    .card:hover {
      border-color: var(--primary);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .card-title {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
      word-break: break-word;
    }

    /* ==================== PACKER ROW ==================== */
    .packer-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1.5fr 1.5fr 0.8fr;
      gap: 8px;
      padding: 12px;
      background: #fdf2f8;
      border-radius: var(--border-radius-sm);
      margin-bottom: 8px;
      border: 1px solid rgba(236, 72, 153, 0.2);
      align-items: end;
    }

    /* ==================== DOWNTIME ROWS - DENGAN FREKUENSI ==================== */
    .downtime-row {
      display: grid;
      grid-template-columns: 2fr 0.5fr 1fr;
      gap: 12px;
      padding: 12px;
      background: #f0f9ff;
      border-radius: var(--border-radius-sm);
      align-items: center;
      margin-bottom: 8px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .lsm-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      padding: 12px;
      background: #faf5ff;
      border-radius: var(--border-radius-sm);
      align-items: center;
      margin-bottom: 8px;
      border: 1px solid rgba(168, 85, 247, 0.2);
    }

    .lsnm-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      padding: 12px;
      background: #f0fdf4;
      border-radius: var(--border-radius-sm);
      align-items: center;
      margin-bottom: 8px;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .ms-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      padding: 12px;
      background: #fef3c7;
      border-radius: var(--border-radius-sm);
      align-items: center;
      margin-bottom: 8px;
      border: 1px solid rgba(217, 119, 6, 0.2);
    }

    /* ==================== TABLES ==================== */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: var(--border-radius-sm);
      margin-top: 16px;
      border: 1px solid rgba(236, 72, 153, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: clamp(11px, 2vw, 12px);
      min-width: 600px;
    }

    thead {
      background: rgba(236, 72, 153, 0.08);
    }

    thead th {
      padding: 12px 8px;
      text-align: left;
      font-weight: 700;
      color: var(--primary);
      border-bottom: 2px solid rgba(236, 72, 153, 0.2);
      white-space: normal;
      word-break: break-word;
    }

    tbody td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(236, 72, 153, 0.1);
      word-break: break-word;
      white-space: normal;
    }

    tbody tr:hover {
      background: rgba(236, 72, 153, 0.05);
    }

    /* ==================== MASTER DATA GRID ==================== */
    .master-data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .master-card {
      background: white;
      border-radius: var(--border-radius-sm);
      padding: 14px;
      border: 2px solid rgba(236, 72, 153, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }

    .master-card:hover {
      border-color: var(--primary);
    }

    .master-card-content {
      flex: 1;
      min-width: 0;
    }

    .master-card-name {
      font-size: clamp(12px, 2.5vw, 13px);
      font-weight: 700;
      color: #d946a6;
      margin: 0 0 4px;
      word-break: break-word;
      white-space: normal;
    }

    .master-card-detail {
      font-size: clamp(10px, 2vw, 11px);
      color: #b9a2b3;
      margin: 0;
      word-break: break-word;
      white-space: normal;
    }

    .master-card-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn-edit, .btn-delete {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: clamp(9px, 1.5vw, 10px);
      font-weight: 600;
      transition: var(--transition);
      white-space: nowrap;
    }

    .btn-edit {
      background: var(--secondary);
      color: white;
    }

    .btn-edit:hover {
      background: #9333ea;
    }

    .btn-delete {
      background: var(--danger);
      color: white;
    }

    .btn-delete:hover {
      background: #dc2626;
    }

    /* ==================== EMPTY STATE ==================== */
    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: #b9a2b3;
    }

    .empty-state-icon {
      font-size: clamp(32px, 8vw, 48px);
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: clamp(11px, 2vw, 13px);
      font-weight: 600;
      letter-spacing: 0.5px;
      word-break: break-word;
    }

    /* ==================== WARNING ==================== */
    .warning-box {
      background: #fef2f2;
      border: 2px solid var(--danger);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      color: #dc2626;
    }

    .warning-title {
      margin: 0 0 8px;
      font-weight: 700;
      font-size: 13px;
      word-break: break-word;
    }

    .warning-text {
      margin: 0;
      font-size: 12px;
      word-break: break-word;
    }

    /* ==================== CHARTS ==================== */
    .chart-container {
      background: white;
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--box-shadow);
      border: 1px solid rgba(236, 72, 153, 0.1);
      overflow-x: auto;
    }

    .chart-title {
      font-size: clamp(12px, 3vw, 13px);
      font-weight: 700;
      color: #d946a6;
      margin-bottom: 16px;
      word-break: break-word;
    }

    .chart-wrapper {
      position: relative;
      min-height: 300px;
      width: 100%;
    }

    canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 300px;
    }

    /* ==================== TOAST ==================== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
      max-width: 90vw;
    }

    .toast {
      background: white;
      color: var(--text-dark);
      padding: 14px 20px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      font-size: 12px;
      font-weight: 600;
      animation: slideIn 0.3s ease;
      pointer-events: auto;
      border-left: 4px solid var(--primary);
      word-break: break-word;
    }

    .toast.success {
      border-left-color: var(--success);
      background: linear-gradient(135deg, #f0fdf4 0%, #f9fce8 100%);
    }

    .toast.error {
      border-left-color: var(--danger);
      background: linear-gradient(135deg, #fef2f2 0%, #fff5f5 100%);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ==================== MODAL ==================== */
    #modal-backdrop, #login-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
    }

    #modal, #login-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      padding: 24px;
      z-index: 9999;
      width: 90%;
      max-width: 450px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    #modal-title, .login-title {
      margin: 0 0 20px;
      color: var(--primary);
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      word-break: break-word;
    }

    .login-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #f3e8f0;
      border-radius: var(--border-radius-sm);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .login-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }

    .login-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: -12px;
      margin-bottom: 16px;
      text-align: center;
      font-weight: 600;
      word-break: break-word;
    }

    .login-buttons {
      display: flex;
      gap: 12px;
    }

    /* ==================== DARK MODE ==================== */
    body.dark-mode {
      background: linear-gradient(135deg, #1f1729 0%, #2d1f35 50%, #3d2640 100%);
      color: var(--text-light);
    }

    body.dark-mode .form-section,
    body.dark-mode .score-card,
    body.dark-mode .chart-container,
    body.dark-mode .card,
    body.dark-mode .master-card,
    body.dark-mode #modal,
    body.dark-mode #login-modal {
      background: #2d2236;
      border-color: rgba(236, 72, 153, 0.15);
      color: var(--text-light);
    }

    body.dark-mode .form-group label,
    body.dark-mode .score-label {
      color: #b9a2b3;
    }

    body.dark-mode .form-group input,
    body.dark-mode .form-group select,
    body.dark-mode .input-field {
      background: #1f1729;
      color: var(--text-light);
      border-color: #403050;
    }

    body.dark-mode .form-group input:focus,
    body.dark-mode .form-group select:focus,
    body.dark-mode .input-field:focus {
      background: #2d2236;
      border-color: var(--primary);
    }

    body.dark-mode thead {
      background: rgba(60, 40, 60, 0.8);
    }

    body.dark-mode thead th {
      color: #f472b6;
    }

    body.dark-mode tbody td {
      color: var(--text-light);
    }

    body.dark-mode .tab-btn {
      color: #9ca3af;
    }

    body.dark-mode .tab-btn:hover,
    body.dark-mode .tab-btn.active {
      color: #f472b6;
    }

    body.dark-mode .section-title,
    body.dark-mode .chart-title,
    body.dark-mode .card-title,
    body.dark-mode .master-card-name {
      color: #f472b6;
    }

    body.dark-mode .master-card-detail {
      color: #9ca3af;
    }

    /* ==================== RESPONSIVE BREAKPOINTS ==================== */
    @media (max-width: 640px) {
      .header {
        flex-direction: column;
        text-align: center;
        padding: 12px;
      }

      .header-datetime {
        text-align: center;
        align-items: center;
      }

      .score-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .score-card {
        padding: 12px 8px;
      }

      .score-value {
        font-size: 20px;
      }

      .packer-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .downtime-row {
        grid-template-columns: 1fr;
      }
      
      .lsm-row,
      .lsnm-row,
      .ms-row {
        grid-template-columns: 1fr;
      }

      .btn {
        width: 100%;
      }

      .master-card {
        flex-direction: column;
        text-align: center;
      }

      .master-card-actions {
        width: 100%;
        justify-content: center;
      }

      .card-header {
        flex-direction: column;
      }

      .card-header button {
        width: 100%;
      }

      #modal, #login-modal {
        width: 95%;
        padding: 20px;
      }
      
      .chart-wrapper {
        min-height: 250px;
      }
    }

    @media (min-width: 641px) and (max-width: 1024px) {
      .score-cards {
        grid-template-columns: repeat(3, 1fr);
      }

      .packer-row {
        grid-template-columns: repeat(3, 1fr);
      }

      .master-data-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1025px) {
      .score-cards {
        grid-template-columns: repeat(7, 1fr);
      }

      .master-data-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .content {
        padding: 24px;
      }
    }

    /* ==================== UTILITIES ==================== */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .w-100 { width: 100%; }
    .mt-16 { margin-top: 16px; }
    .mb-16 { margin-bottom: 16px; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .gap-8 { gap: 8px; }
    .gap-12 { gap: 12px; }
    .word-break { word-break: break-word; }
    .white-space-normal { white-space: normal; }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>
<body>
<div id="app">
  <!-- ==================== HEADER ==================== -->
  <div class="header">
    <div class="header-content">
      <h1>‚ú® OEE KEMAS SEKUNDER</h1>
      <p>CREATED BY MSTD GOF</p>
    </div>
    <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
      <div class="header-datetime">
        <div class="header-datetime-time" id="current-time">00:00:00</div>
        <div id="current-date">TANGGAL</div>
      </div>
      <button class="mode-toggle" onclick="toggleDarkMode()">
        <span id="mode-icon">üåô</span>
        <span id="mode-text">DARK</span>
      </button>
    </div>
  </div>

  <!-- ==================== TABS ==================== -->
  <div class="tabs-container">
    <button class="tab-btn active" onclick="switchTab('dashboard')">üìà DASHBOARD</button>
    <button class="tab-btn" onclick="switchTab('input')">‚úèÔ∏è INPUT OEE</button>
    <button class="tab-btn" onclick="switchTab('master')">üíæ MASTER DATA</button>
    <button class="tab-btn" onclick="switchTab('audit')">‚öôÔ∏è AUDIT TRAIL</button>
  </div>

  <!-- ==================== CONTENT ==================== -->
  <div class="content">
    <!-- ==================== DASHBOARD TAB ==================== -->
    <div id="dashboard" class="tab-content active">
      <div class="form-section">
        <div class="section-title">FILTER DATA</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
          <div class="form-group">
            <label>TANGGAL MULAI</label>
            <input type="date" id="filter-date-start" class="input-field" onchange="applyDashboardFilters()">
          </div>
          <div class="form-group">
            <label>TANGGAL AKHIR</label>
            <input type="date" id="filter-date-end" class="input-field" onchange="applyDashboardFilters()">
          </div>
          <div class="form-group">
            <label>SHIFT</label>
            <select id="filter-shift" class="input-field" onchange="applyDashboardFilters()">
              <option value="">-- SEMUA SHIFT --</option>
              <option value="Shift 1">SHIFT 1</option>
              <option value="Shift 2">SHIFT 2</option>
              <option value="Shift 3">SHIFT 3</option>
              <option value="Longshift Pagi">LONGSHIFT PAGI</option>
              <option value="Longshift Malam">LONGSHIFT MALAM</option>
            </select>
          </div>
          <div class="form-group">
            <label>PRODUK</label>
            <select id="filter-product" class="input-field" onchange="applyDashboardFilters()">
              <option value="">-- SEMUA PRODUK --</option>
            </select>
          </div>
          <div class="form-group">
            <label>PACKER</label>
            <select id="filter-packer" class="input-field" onchange="applyDashboardFilters()">
              <option value="">-- SEMUA PACKER --</option>
            </select>
          </div>
          <div style="display: flex; align-items: flex-end;">
            <button class="btn btn-secondary w-100" onclick="resetDashboardFilters()">RESET FILTER</button>
          </div>
        </div>
      </div>

      <!-- SCORE CARDS DASHBOARD -->
      <div class="score-cards">
        <div class="score-card" id="score-card-oee-actual">
          <div class="score-label">OEE ACTUAL</div>
          <div class="score-value" id="score-oee-actual">0%</div>
        </div>
        <div class="score-card" id="score-card-oee-365">
          <div class="score-label">OEE 365</div>
          <div class="score-value" id="score-oee-365">0%</div>
        </div>
        <div class="score-card">
          <div class="score-label">TOTAL OUTPUT</div>
          <div class="score-value" id="score-total-output" style="font-size: 24px;">0</div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="chart-container">
        <div class="chart-title">OEE PER BULAN (12 BULAN)</div>
        <div class="chart-wrapper">
          <canvas id="chart-oee-monthly"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">OEE PER HARI (30 HARI TERAKHIR)</div>
        <div class="chart-wrapper">
          <canvas id="chart-oee-daily"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">A / P / Q / 365 BREAKDOWN</div>
        <div class="chart-wrapper">
          <canvas id="chart-apqa-breakdown"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">TOP 10 ODT (MENIT)</div>
        <div class="chart-wrapper">
          <canvas id="chart-odt-top10"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">TOP 10 LINE STOP MESIN (MENIT)</div>
        <div class="chart-wrapper">
          <canvas id="chart-lsm-top10"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">TOP 10 LINE STOP NON-MESIN (MENIT)</div>
        <div class="chart-wrapper">
          <canvas id="chart-lsnm-top10"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">TOP 10 MINOR STOP (MENIT)</div>
        <div class="chart-wrapper">
          <canvas id="chart-ms-top10"></canvas>
        </div>
      </div>

      <!-- PACKER PERFORMANCE TABLE -->
      <div class="form-section">
        <div class="section-title">PERFORMA PACKER</div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>NO</th>
                <th>PACKER</th>
                <th>AVG OEE ACTUAL</th>
                <th>TARGET OUTPUT</th>
                <th>OUTPUT ACTUAL</th>
                <th>RECORDS</th>
              </tr>
            </thead>
            <tbody id="table-packer-performance"></tbody>
          </table>
        </div>
      </div>

      <!-- OEE HISTORY TABLE -->
      <div class="form-section">
        <div class="section-title">RIWAYAT OEE</div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>TANGGAL</th>
                <th>SHIFT</th>
                <th>PACKER</th>
                <th>NOMOR BATCH</th>
                <th>OEE ACTUAL</th>
                <th>OEE 365</th>
                <th>NOTES</th>
              </tr>
            </thead>
            <tbody id="table-oee-history"></tbody>
          </table>
        </div>
      </div>

      <!-- LINE STOP MESIN DETAIL -->
      <div class="form-section">
        <div class="section-title">DETAIL LINE STOP MESIN</div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>TANGGAL</th>
                <th>SHIFT</th>
                <th>PACKER</th>
                <th>LINE STOP MESIN</th>
                <th>DURASI (MENIT)</th>
                <th>NO WR</th>
                <th>ACTION</th>
              </tr>
            </thead>
            <tbody id="table-lsm-detail"></tbody>
          </table>
        </div>
      </div>

      <!-- LINE STOP NON-MESIN DETAIL -->
      <div class="form-section">
        <div class="section-title">DETAIL LINE STOP NON-MESIN</div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>TANGGAL</th>
                <th>SHIFT</th>
                <th>PACKER</th>
                <th>LINE STOP NON-MESIN</th>
                <th>DURASI (MENIT)</th>
                <th>ACTION</th>
              </tr>
            </thead>
            <tbody id="table-lsnm-detail"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ==================== INPUT OEE TAB ==================== -->
    <div id="input" class="tab-content">
      <form id="form-oee" onsubmit="submitOEE(event)">
        <!-- INFORMASI SHIFT -->
        <div class="form-section">
          <div class="section-title">INFORMASI SHIFT</div>
          <div class="form-row">
            <div class="form-group">
              <label>TANGGAL</label>
              <input type="date" id="oee-date" required>
            </div>
            <div class="form-group">
              <label>SHIFT</label>
              <select id="oee-shift" onchange="updateShiftMinutes()">
                <option value="">-- PILIH SHIFT --</option>
                <option value="Shift 1">SHIFT 1 (07:00 - 15:30)</option>
                <option value="Shift 2">SHIFT 2 (15:20 - 22:50)</option>
                <option value="Shift 3">SHIFT 3 (22:40 - 07:10)</option>
                <option value="Longshift Pagi">LONGSHIFT PAGI (07:00 - 19:00)</option>
                <option value="Longshift Malam">LONGSHIFT MALAM (19:00 - 07:00)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- OPERATIONAL DOWNTIME (ODT) - DENGAN FREKUENSI -->
        <div class="form-section">
          <div class="section-title">OPERATIONAL DOWNTIME (ODT)</div>
          <div id="odt-list"></div>
        </div>

        <!-- LINE STOP MESIN -->
        <div class="form-section">
          <div class="section-title">LINE STOP MESIN</div>
          <div id="line-stop-mesin-list"></div>
        </div>

        <!-- LINE STOP NON-MESIN -->
        <div class="form-section">
          <div class="section-title">LINE STOP NON-MESIN</div>
          <div id="line-stop-non-mesin-list"></div>
        </div>

        <!-- MINOR STOP -->
        <div class="form-section">
          <div class="section-title">MINOR STOP</div>
          <button type="button" class="btn btn-success w-100" onclick="addMinorStop()">+ TAMBAH MINOR STOP</button>
          <div id="minor-stop-list" class="mt-16"></div>
        </div>

        <!-- PACKER METER -->
        <div class="form-section">
          <div class="section-title">PACKER METER</div>
          <button type="button" class="btn btn-success w-100" onclick="addPackerMeter()">+ TAMBAH METER</button>
          <div id="packer-meter-list" class="mt-16"></div>
        </div>

        <!-- NOTES -->
        <div class="form-section">
          <div class="section-title">NOTES</div>
          <div class="form-group">
            <textarea id="oee-notes" rows="3" placeholder="TAMBAHKAN CATATAN (OPSIONAL)"></textarea>
          </div>
        </div>

        <!-- HASIL PERHITUNGAN OEE -->
        <div class="form-section">
          <div id="availability-warning" style="display: none;"></div>
          <div id="oee-over100-warning" style="display: none;" class="warning-box"></div>
          <div class="section-title">HASIL PERHITUNGAN OEE</div>
          <div class="score-cards">
            <div class="score-card">
              <div class="score-label">AVAILABILITY (ACTUAL)</div>
              <div class="score-value" id="calc-availability-actual">0%</div>
            </div>
            <div class="score-card">
              <div class="score-label">AVAILABILITY 365</div>
              <div class="score-value" id="calc-availability-365">0%</div>
            </div>
            <div class="score-card">
              <div class="score-label">PERFORMANCE</div>
              <div class="score-value" id="calc-performance">0%</div>
            </div>
            <div class="score-card">
              <div class="score-label">QUALITY RATE</div>
              <div class="score-value" id="calc-quality">0%</div>
            </div>
            <div class="score-card">
              <div class="score-label">OEE (ACTUAL)</div>
              <div class="score-value" id="calc-oee-actual">0%</div>
            </div>
            <div class="score-card">
              <div class="score-label">OEE 365</div>
              <div class="score-value" id="calc-oee-365">0%</div>
            </div>
            <div class="score-card">
              <div class="score-label">TOTAL OUTPUT</div>
              <div class="score-value" id="calc-total-output" style="font-size: 24px;">0 DUS</div>
            </div>
          </div>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="form-section" style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button type="submit" class="btn btn-primary" style="flex: 1;" id="submit-oee-btn">üíæ SIMPAN DATA OEE</button>
          <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="resetOEEForm()">üîÑ RESET FORM</button>
        </div>
      </form>
    </div>

    <!-- ==================== MASTER DATA TAB ==================== -->
    <div id="master" class="tab-content">
      <div class="form-section">
        <div class="section-title">MASTER PRODUK</div>
        <button class="btn btn-primary w-100" onclick="openAddProductModal()">+ PRODUK BARU</button>
        <div id="product-list" class="master-data-grid"></div>
      </div>
      <div class="form-section">
        <div class="section-title">MASTER PACKER</div>
        <button class="btn btn-primary w-100" onclick="openAddPackerModal()">+ PACKER BARU</button>
        <div id="packer-list" class="master-data-grid"></div>
      </div>
      <div class="form-section">
        <div class="section-title">MASTER ODT</div>
        <button class="btn btn-primary w-100" onclick="openAddODTModal()">+ ODT BARU</button>
        <div id="odt-master-list" class="master-data-grid"></div>
      </div>
      <div class="form-section">
        <div class="section-title">MASTER LINE STOP MESIN</div>
        <button class="btn btn-primary w-100" onclick="openAddLineStopMesinModal()">+ LINE STOP BARU</button>
        <div id="line-stop-mesin-master-list" class="master-data-grid"></div>
      </div>
      <div class="form-section">
        <div class="section-title">MASTER LINE STOP NON-MESIN</div>
        <button class="btn btn-primary w-100" onclick="openAddLineStopNonMesinModal()">+ LINE STOP BARU</button>
        <div id="line-stop-non-mesin-master-list" class="master-data-grid"></div>
      </div>
      <div class="form-section">
        <div class="section-title">MASTER MINOR STOP</div>
        <button class="btn btn-primary w-100" onclick="openAddMinorStopModal()">+ MINOR STOP BARU</button>
        <div id="minor-stop-master-list" class="master-data-grid"></div>
      </div>
    </div>

    <!-- ==================== AUDIT TRAIL TAB ==================== -->
    <div id="audit" class="tab-content">
      <div class="form-section">
        <div class="section-title">RIWAYAT AKTIVITAS</div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>WAKTU</th>
                <th>AKTIVITAS</th>
                <th>DETAIL</th>
              </tr>
            </thead>
            <tbody id="audit-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== LOGIN MODAL ==================== -->
<div id="login-backdrop" style="display: none;" onclick="if(event.target === this) closeLoginModal();"></div>
<div id="login-modal" style="display: none;">
  <h2 class="login-title">üîê MASTER DATA ACCESS</h2>
  <form onsubmit="handleLogin(event)">
    <div class="form-group">
      <label class="login-label">PASSWORD</label>
      <input type="password" id="login-password" class="login-input" placeholder="MASUKKAN PASSWORD" autocomplete="off">
    </div>
    <div id="login-error" class="login-error" style="display: none;">PASSWORD SALAH!</div>
    <div class="login-buttons">
      <button type="submit" class="btn btn-primary" style="flex: 1;">LOGIN</button>
      <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeLoginModal()">BATAL</button>
    </div>
  </form>
</div>

<!-- ==================== TOAST CONTAINER ==================== -->
<div id="toast-container" class="toast-container"></div>

<!-- ==================== MODAL BACKDROP ==================== -->
<div id="modal-backdrop" style="display: none;" onclick="if(event.target === this) closeModal();"></div>

<!-- ==================== MODAL ==================== -->
<div id="modal" style="display: none;">
  <h2 id="modal-title">MODAL TITLE</h2>
  <form id="modal-form" onsubmit="submitModalForm(event)">
    <div id="modal-fields"></div>
    <div style="display: flex; gap: 12px; margin-top: 24px;">
      <button type="submit" class="btn btn-primary" style="flex: 1;">SIMPAN</button>
      <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">BATAL</button>
    </div>
  </form>
</div>

<script>
  // ==================== SUPABASE CONFIG ====================
  const SUPABASE_URL = 'https://lxtnhdyxrkjbypahdsrf.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4dG5oZHl4cmtqYnlwYWhkc3JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3ODI5MDIsImV4cCI6MjA4NjM1ODkwMn0.BtC1iFgNydjy6gWmk7HPXt70UcgnBCsWj8H89WqfRwA';
  let supabaseClient = null;
  if (window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ==================== MASTER DATA ACCESS ====================
  const MASTER_PASSWORD = 'admin123';
  let isMasterDataUnlocked = false;

  // ==================== LOCAL DATA ====================
  let localData = {
    produk: [],
    packer: [],
    downtime: [],
    line_stop_mesin: [],
    line_stop_non_mesin: [],
    minor_stop: [],
    oee_records: [],
    audit_trail: []
  };

  let oeeFormState = {
    shiftMinutes: 0,
    packerMeters: [],
    downtime: [],
    lineStopMesin: [],
    lineStopNonMesin: [],
    minorStop: [],
    results: {},
    odtOverRecords: [],
    notes: ''
  };

  let dashboardCharts = {};
  let filteredOeeRecords = [];

  // ==================== INIT APP ====================
  async function initApp() {
    await loadDataFromSupabase();
    loadOEEFormData();
    renderMasterDataLists();
    renderAuditTable();
    initDashboardFilters();
    updateDashboard();
    switchTab('dashboard');
  }

  // ==================== SWITCH TAB ====================
  window.switchTab = function(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    document.querySelectorAll('.tab-btn').forEach(btn => {
      if (btn.textContent.includes(tabName === 'dashboard' ? 'DASHBOARD' : 
          tabName === 'input' ? 'INPUT OEE' : 
          tabName === 'master' ? 'MASTER DATA' : 'AUDIT TRAIL')) {
        btn.classList.add('active');
      }
    });
    if (tabName !== 'master') isMasterDataUnlocked = false;
    else if (!isMasterDataUnlocked) showLoginModal();
    if (tabName === 'dashboard') setTimeout(() => renderCharts(), 100);
  };

  // ==================== LOGIN FUNCTIONS ====================
  function showLoginModal() {
    document.getElementById('login-backdrop').style.display = 'block';
    document.getElementById('login-modal').style.display = 'block';
    document.getElementById('login-error').style.display = 'none';
    document.getElementById('login-password').value = '';
    document.getElementById('login-password').focus();
  }

  function closeLoginModal() {
    if (!isMasterDataUnlocked) switchTab('dashboard');
    document.getElementById('login-backdrop').style.display = 'none';
    document.getElementById('login-modal').style.display = 'none';
  }

  function handleLogin(event) {
    event.preventDefault();
    if (document.getElementById('login-password').value === MASTER_PASSWORD) {
      isMasterDataUnlocked = true;
      closeLoginModal();
      showToast('MASTER DATA ACCESS GRANTED ‚úÖ', 'success');
      renderMasterDataLists();
    } else {
      document.getElementById('login-error').style.display = 'block';
      showToast('PASSWORD SALAH!', 'error');
    }
  }

  function checkMasterAccess() {
    if (!isMasterDataUnlocked) {
      showToast('AKSES MASTER DATA DITOLAK! LOGIN TERLEBIH DAHULU', 'error');
      showLoginModal();
      return false;
    }
    return true;
  }

  // ==================== LOAD DATA FROM SUPABASE ====================
  async function loadDataFromSupabase() {
    try {
      const [produkRes, packerRes, downtimeRes, lsmRes, lsnmRes, msRes, oeeRes, auditRes] = await Promise.all([
        supabaseClient.from('produk').select('*'),
        supabaseClient.from('packer').select('*'),
        supabaseClient.from('downtime').select('*'),
        supabaseClient.from('line_stop_mesin').select('*'),
        supabaseClient.from('line_stop_non_mesin').select('*'),
        supabaseClient.from('minor_stop').select('*'),
        supabaseClient.from('oee_records').select('*').order('created_at', { ascending: false }),
        supabaseClient.from('audit_trail').select('*').order('timestamp', { ascending: false })
      ]);
      localData.produk = produkRes.data || [];
      localData.packer = packerRes.data || [];
      localData.downtime = downtimeRes.data || [];
      localData.line_stop_mesin = lsmRes.data || [];
      localData.line_stop_non_mesin = lsnmRes.data || [];
      localData.minor_stop = msRes.data || [];
      localData.oee_records = oeeRes.data || [];
      localData.audit_trail = auditRes.data || [];
      
      console.log('‚úÖ Data loaded from Supabase. OEE records:', localData.oee_records.length);
    } catch (error) {
      console.error('Error loading data:', error);
      showToast('ERROR LOADING DATA FROM SUPABASE', 'error');
    }
  }

  // ==================== SHIFT ====================
  function updateShiftMinutes() {
    const shift = document.getElementById('oee-shift').value;
    const shiftSchedule = { 'Shift 1': 510, 'Shift 2': 510, 'Shift 3': 510, 'Longshift Pagi': 720, 'Longshift Malam': 720 };
    oeeFormState.shiftMinutes = shiftSchedule[shift] || 0;
    renderODTList();
    renderLineStopMesinList();
    renderLineStopNonMesinList();
    renderMinorStopList();
    renderPackerMeterList();
  }

  // ==================== PACKER METER ====================
  function addPackerMeter() {
    if (!document.getElementById('oee-shift').value) {
      showToast('PILIH SHIFT TERLEBIH DAHULU', 'error');
      return;
    }
    
    // HITUNG TOTAL ODT DENGAN FREKUENSI
    const totalODT = oeeFormState.downtime.reduce((s, o) => s + ((parseFloat(o.frekuensi) || 1) * (parseFloat(o.durasi) || 0)), 0);
    const totalLSM = oeeFormState.lineStopMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    const totalLSNM = oeeFormState.lineStopNonMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    
    let totalMaxDuration = 0;
    oeeFormState.packerMeters.forEach(meter => {
      let maxDurInMeter = 0;
      meter.packers.forEach(packer => {
        maxDurInMeter = Math.max(maxDurInMeter, packer.duration || 0);
      });
      totalMaxDuration += maxDurInMeter;
    });
    
    const remainingTime = Math.max(0, oeeFormState.shiftMinutes - totalODT - totalLSM - totalLSNM - totalMaxDuration);
    
    oeeFormState.packerMeters.push({
      id: 'meter_' + Date.now(),
      productId: '',
      batchNumber: '',
      remainingTime: remainingTime,
      packers: []
    });
    
    renderPackerMeterList();
  }

  function renderPackerMeterList() {
    const listDiv = document.getElementById('packer-meter-list');
    if (oeeFormState.packerMeters.length === 0) {
      listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-text">BELUM ADA METER DITAMBAHKAN</div></div>';
      return;
    }
    
    // HITUNG TOTAL ODT DENGAN FREKUENSI
    const totalODT = oeeFormState.downtime.reduce((s, o) => s + ((parseFloat(o.frekuensi) || 1) * (parseFloat(o.durasi) || 0)), 0);
    const totalLSM = oeeFormState.lineStopMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    const totalLSNM = oeeFormState.lineStopNonMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    
    listDiv.innerHTML = oeeFormState.packerMeters.map((meter, index) => {
      let totalMaxPreviousDuration = 0;
      for (let i = 0; i < index; i++) {
        const meterPrev = oeeFormState.packerMeters[i];
        let maxDurInMeter = 0;
        meterPrev.packers.forEach(p => {
          maxDurInMeter = Math.max(maxDurInMeter, p.duration || 0);
        });
        totalMaxPreviousDuration += maxDurInMeter;
      }
      
      meter.remainingTime = Math.max(0, oeeFormState.shiftMinutes - totalODT - totalLSM - totalLSNM - totalMaxPreviousDuration);
      
      return `
        <div class="card" data-meter-id="${meter.id}">
          <div class="card-header">
            <h3 class="card-title">METER ${index + 1}</h3>
            <button type="button" class="btn btn-danger btn-small" onclick="removePackerMeter('${meter.id}')">HAPUS</button>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>PRODUK</label>
              <select class="meter-product input-field" onchange="updatePackerMeter('${meter.id}', 'product')">
                <option value="">-- PILIH PRODUK --</option>
                ${localData.produk.map(p => `<option value="${p.id}" ${meter.productId === p.id ? 'selected' : ''}>${p.nama}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>BATCH NUMBER</label>
              <input type="text" class="meter-batch input-field" value="${meter.batchNumber}" placeholder="BATCH NUMBER" onchange="updatePackerMeter('${meter.id}', 'batch')">
            </div>
            <div class="form-group">
              <label>SISA WAKTU (MENIT)</label>
              <input type="number" class="meter-remaining-time input-field" value="${meter.remainingTime.toFixed(0)}" readonly>
            </div>
          </div>
          <div style="margin-top: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
              <h4 class="section-title" style="margin: 0; font-size: 14px;">PACKER</h4>
              <button type="button" class="btn btn-success btn-small" onclick="addPackerToMeter('${meter.id}')">+ TAMBAH PACKER</button>
            </div>
            <div id="packers-${meter.id}"></div>
          </div>
        </div>
      `;
    }).join('');
    
    oeeFormState.packerMeters.forEach(meter => renderPackersInMeter(meter));
    updateAvailabilityWarning();
  }

  function renderPackersInMeter(meter) {
    const container = document.getElementById(`packers-${meter.id}`);
    if (!container) return;
    if (meter.packers.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-text" style="font-size: 12px;">BELUM ADA PACKER DITAMBAHKAN</div></div>';
      return;
    }
    container.innerHTML = meter.packers.map(packer => `
      <div class="packer-row" id="packer-${packer.id}">
        <div class="form-group">
          <label style="font-size: 10px;">PACKER</label>
          <select class="packer-name input-field" style="font-size: 11px;" onchange="updatePacker('${packer.id}', '${meter.id}')">
            <option value="">PILIH</option>
            ${localData.packer.map(p => `<option value="${p.id}|${p.nama}" ${packer.packerId === p.id ? 'selected' : ''}>${p.nama}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label style="font-size: 10px;">DURASI (MIN)</label>
          <input type="number" class="packer-duration input-field" style="font-size: 11px;" value="${packer.duration}" min="0" max="${meter.remainingTime}" placeholder="ACTUAL TIME" onchange="validatePackerDuration(this, '${packer.id}', '${meter.id}')">
        </div>
        <div class="form-group">
          <label style="font-size: 10px;">OUTPUT (DUS)</label>
          <input type="number" class="packer-output input-field" style="font-size: 11px;" value="${packer.output}" placeholder="OUTPUT" onchange="updatePacker('${packer.id}', '${meter.id}')">
        </div>
        <div class="form-group">
          <label style="font-size: 10px;">REJECT (DUS)</label>
          <input type="number" class="packer-reject input-field" style="font-size: 11px;" value="${packer.reject}" placeholder="REJECT" onchange="updatePacker('${packer.id}', '${meter.id}')">
        </div>
        <div style="display: flex; align-items: flex-end;">
          <button type="button" class="btn btn-danger btn-small w-100" style="padding: 8px; font-size: 11px;" onclick="removePacker('${packer.id}', '${meter.id}')">HAPUS</button>
        </div>
      </div>
    `).join('');
  }

  function validatePackerDuration(input, packerId, meterId) {
    const meter = oeeFormState.packerMeters.find(m => m.id === meterId);
    if (!meter) return;
    const packer = meter.packers.find(p => p.id === packerId);
    if (!packer) return;
    let duration = parseFloat(input.value) || 0;
    if (duration > meter.remainingTime) {
      showToast(`DURASI TIDAK BOLEH MELEBIHI SISA WAKTU (${meter.remainingTime.toFixed(0)} MENIT)`, 'error');
      duration = meter.remainingTime;
      input.value = duration;
    }
    packer.duration = duration;
    updatePacker(packerId, meterId);
  }

  function removePackerMeter(meterId) {
    oeeFormState.packerMeters = oeeFormState.packerMeters.filter(m => m.id !== meterId);
    renderPackerMeterList();
    calculateOEE();
  }

  function addPackerToMeter(meterId) {
    const meter = oeeFormState.packerMeters.find(m => m.id === meterId);
    if (meter) {
      meter.packers.push({ 
        id: 'packer_' + Date.now(), 
        packerId: '', 
        packerName: '', 
        duration: 0, 
        output: 0, 
        reject: 0 
      });
      renderPackersInMeter(meter);
    }
  }

  function updatePackerMeter(meterId, field) {
    const meter = oeeFormState.packerMeters.find(m => m.id === meterId);
    if (!meter) return;
    const meterDiv = document.querySelector(`[data-meter-id="${meterId}"]`);
    if (!meterDiv) return;
    if (field === 'product') meter.productId = meterDiv.querySelector('.meter-product').value;
    else if (field === 'batch') meter.batchNumber = meterDiv.querySelector('.meter-batch').value;
    calculateOEE();
  }

  function updatePacker(packerId, meterId) {
    const meter = oeeFormState.packerMeters.find(m => m.id === meterId);
    if (!meter) return;
    const packer = meter.packers.find(p => p.id === packerId);
    if (!packer) return;
    const packerDiv = document.getElementById(`packer-${packerId}`);
    if (!packerDiv) return;
    const [packerId_, packerName] = packerDiv.querySelector('.packer-name').value.split('|') || ['', ''];
    packer.packerId = packerId_;
    packer.packerName = packerName;
    packer.duration = parseFloat(packerDiv.querySelector('.packer-duration').value) || 0;
    packer.output = parseFloat(packerDiv.querySelector('.packer-output').value) || 0;
    packer.reject = parseFloat(packerDiv.querySelector('.packer-reject').value) || 0;
    renderPackerMeterList();
    calculateOEE();
  }

  function removePacker(packerId, meterId) {
    const meter = oeeFormState.packerMeters.find(m => m.id === meterId);
    if (meter) {
      meter.packers = meter.packers.filter(p => p.id !== packerId);
      renderPackersInMeter(meter);
      renderPackerMeterList();
    }
    calculateOEE();
  }

  function updateAvailabilityWarning() {
    const warningDiv = document.getElementById('availability-warning');
    if (!warningDiv) return;
    
    // HITUNG TOTAL ODT DENGAN FREKUENSI
    const totalODT = oeeFormState.downtime.reduce((s, o) => s + ((parseFloat(o.frekuensi) || 1) * (parseFloat(o.durasi) || 0)), 0);
    const totalLSM = oeeFormState.lineStopMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    const totalLSNM = oeeFormState.lineStopNonMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    
    let totalMaxDuration = 0;
    oeeFormState.packerMeters.forEach(meter => {
      let maxDurInMeter = 0;
      meter.packers.forEach(p => {
        maxDurInMeter = Math.max(maxDurInMeter, p.duration || 0);
      });
      totalMaxDuration += maxDurInMeter;
    });
    
    const totalUsedTime = totalODT + totalLSM + totalLSNM + totalMaxDuration;
    
    if (totalUsedTime > oeeFormState.shiftMinutes && oeeFormState.shiftMinutes > 0) {
      warningDiv.innerHTML = `
        <div class="warning-box">
          <p class="warning-title">‚ö†Ô∏è WARNING: TOTAL WAKTU MELEBIHI SHIFT</p>
          <p class="warning-text">TOTAL WAKTU TERPAKAI (${totalUsedTime.toFixed(0)} MENIT) MELEBIHI DURASI SHIFT (${oeeFormState.shiftMinutes} MENIT). PERIKSA KEMBALI DATA ANDA.</p>
        </div>
      `;
      warningDiv.style.display = 'block';
    } else warningDiv.style.display = 'none';
  }

  // ==================== ODT - DENGAN FREKUENSI ====================
  function renderODTList() {
    const listDiv = document.getElementById('odt-list');
    if (localData.downtime.length === 0) {
      listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-text">BELUM ADA DATA ODT</div></div>';
      return;
    }
    if (oeeFormState.downtime.length === 0) {
      oeeFormState.downtime = localData.downtime.map(d => ({ 
        id: d.id, 
        nama: d.nama, 
        waktu_standard: d.waktu_standard, 
        frekuensi: 1,
        durasi: 0 
      }));
    }
    listDiv.innerHTML = oeeFormState.downtime.map(odt => {
      const totalDurasi = (parseFloat(odt.frekuensi) || 1) * (parseFloat(odt.durasi) || 0);
      return `
        <div class="downtime-row">
          <div>
            <p style="font-size: 13px; font-weight: 700; color: #3b82f6; margin: 0 0 4px;">${odt.nama}</p>
            <p style="font-size: 11px; color: #60a5fa; margin: 0;">STD: ${odt.waktu_standard} MENIT</p>
            <p style="font-size: 11px; color: #ef4444; margin: 4px 0 0;">TOTAL: ${totalDurasi} MENIT</p>
          </div>
          <div class="form-group" style="min-width: 60px;">
            <label style="font-size: 9px;">FREKUENSI</label>
            <input type="number" class="input-field" value="${odt.frekuensi || 1}" min="1" step="1" placeholder="FREK" onchange="updateODTFrekuensi('${odt.id}', this.value)">
          </div>
          <input type="number" class="input-field" value="${odt.durasi}" min="0" placeholder="DURASI" onchange="updateODT('${odt.id}', this.value)">
        </div>
      `;
    }).join('');
  }

  function updateODTFrekuensi(id, frekuensi) {
    const odt = oeeFormState.downtime.find(o => o.id === id);
    if (odt) {
      odt.frekuensi = parseInt(frekuensi) || 1;
      if (odt.frekuensi < 1) odt.frekuensi = 1;
      renderODTList();
      calculateOEE();
    }
  }

  function updateODT(id, durasi) {
    const odt = oeeFormState.downtime.find(o => o.id === id);
    if (!odt) return;
    
    const actualDurasi = parseFloat(durasi) || 0;
    const standar = odt.waktu_standard;
    const frekuensi = odt.frekuensi || 1;
    
    const selisihPerKejadian = Math.max(0, actualDurasi - standar);
    const totalSelisih = selisihPerKejadian * frekuensi;
    
    odt.durasi = actualDurasi;
    
    const odtOverName = `ODT OVER ${odt.nama}`;
    
    const existingIndex = oeeFormState.lineStopNonMesin.findIndex(l => l.nama === odtOverName);
    
    if (totalSelisih > 0) {
      if (existingIndex >= 0) {
        oeeFormState.lineStopNonMesin[existingIndex].durasi = totalSelisih;
      } else {
        oeeFormState.lineStopNonMesin.push({
          id: `lsnm_odtover_${odt.id}_${Date.now()}`,
          nama: odtOverName,
          durasi: totalSelisih,
          action: '',
          isCustom: true
        });
      }
    } else {
      oeeFormState.lineStopNonMesin = oeeFormState.lineStopNonMesin.filter(l => l.nama !== odtOverName);
    }
    
    renderLineStopNonMesinList();
    renderODTList();
    renderPackerMeterList();
    calculateOEE();
  }

  // ==================== LINE STOP MESIN ====================
  function renderLineStopMesinList() {
    const listDiv = document.getElementById('line-stop-mesin-list');
    if (localData.line_stop_mesin.length === 0 && oeeFormState.lineStopMesin.length === 0) {
      listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-text">BELUM ADA DATA</div></div>';
      return;
    }
    if (oeeFormState.lineStopMesin.length === 0) {
      oeeFormState.lineStopMesin = localData.line_stop_mesin.map(m => ({ 
        id: m.id, 
        nama: m.nama, 
        durasi: 0, 
        action: '', 
        wr: '', 
        isCustom: false 
      }));
    }
    listDiv.innerHTML = oeeFormState.lineStopMesin.map(lsm => {
      const wrRequired = (parseFloat(lsm.durasi) || 0) >= 180;
      return `
        <div class="lsm-row">
          <div><p style="font-size: 13px; font-weight: 700; color: #a855f7; margin: 0;">${lsm.nama}</p></div>
          <input type="number" class="input-field" value="${lsm.durasi}" min="0" placeholder="ACTUAL TIME" onchange="updateLineStopMesin('${lsm.id}', 'durasi', this.value)">
          <input type="text" class="input-field" value="${lsm.action}" placeholder="ACTION" onchange="updateLineStopMesin('${lsm.id}', 'action', this.value)">
          <input type="text" class="input-field" style="${wrRequired ? 'border-color: #ef4444;' : ''}" value="${lsm.wr}" placeholder="NO WR${wrRequired ? ' *' : ''}" onchange="updateLineStopMesin('${lsm.id}', 'wr', this.value)">
        </div>
      `;
    }).join('');
  }

  function updateLineStopMesin(id, field, value) {
    const lsm = oeeFormState.lineStopMesin.find(l => l.id === id);
    if (lsm) lsm[field] = value;
    renderPackerMeterList();
    calculateOEE();
  }

  // ==================== LINE STOP NON-MESIN ====================
  function renderLineStopNonMesinList() {
    const listDiv = document.getElementById('line-stop-non-mesin-list');
    
    let allLSNM = [];
    
    if (localData.line_stop_non_mesin && localData.line_stop_non_mesin.length > 0) {
      const masterLSNM = localData.line_stop_non_mesin.map(m => ({ 
        id: m.id, 
        nama: m.nama, 
        durasi: 0, 
        action: '', 
        isCustom: false 
      }));
      allLSNM = [...allLSNM, ...masterLSNM];
    }
    
    if (oeeFormState.lineStopNonMesin && oeeFormState.lineStopNonMesin.length > 0) {
      const customLSNM = oeeFormState.lineStopNonMesin.filter(l => l.isCustom);
      allLSNM = [...allLSNM, ...customLSNM];
    }
    
    const uniqueLSNM = [];
    const ids = new Set();
    allLSNM.forEach(l => {
      if (!ids.has(l.id)) {
        ids.add(l.id);
        uniqueLSNM.push(l);
      }
    });
    
    oeeFormState.lineStopNonMesin = uniqueLSNM;

    if (oeeFormState.lineStopNonMesin.length === 0) {
      listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-text">BELUM ADA DATA</div></div>';
      return;
    }

    listDiv.innerHTML = oeeFormState.lineStopNonMesin.map(lsnm => `
      <div class="lsnm-row">
        <div>
          <p style="font-size: 13px; font-weight: 700; color: #10b981; margin: 0;">${lsnm.nama}</p>
        </div>
        <input type="number" class="input-field" value="${lsnm.durasi}" min="0" placeholder="ACTUAL TIME" onchange="updateLineStopNonMesin('${lsnm.id}', 'durasi', this.value)">
        <input type="text" class="input-field" value="${lsnm.action}" placeholder="ACTION" onchange="updateLineStopNonMesin('${lsnm.id}', 'action', this.value)">
        ${lsnm.isCustom ? `<button type="button" class="btn btn-danger btn-small" style="padding: 8px;" onclick="removeLineStopNonMesin('${lsnm.id}')">HAPUS</button>` : ''}
      </div>
    `).join('');
  }

  function updateLineStopNonMesin(id, field, value) {
    const lsnm = oeeFormState.lineStopNonMesin.find(l => l.id === id);
    if (lsnm) {
      lsnm[field] = value;
    }
    renderPackerMeterList();
    calculateOEE();
  }

  function removeLineStopNonMesin(id) {
    oeeFormState.lineStopNonMesin = oeeFormState.lineStopNonMesin.filter(l => l.id !== id);
    renderLineStopNonMesinList();
    calculateOEE();
  }

  // ==================== MINOR STOP ====================
  function addMinorStop() {
    const nama = prompt('MASUKKAN NAMA MINOR STOP:', '');
    if (!nama || !nama.trim()) {
      showToast('NAMA MINOR STOP WAJIB DIISI', 'error');
      return;
    }
    oeeFormState.minorStop.push({ 
      id: 'ms_' + Date.now(), 
      nama: nama.trim().toUpperCase(), 
      durasi: 0, 
      isCustom: true 
    });
    renderMinorStopList();
  }

  function renderMinorStopList() {
    const listDiv = document.getElementById('minor-stop-list');
    
    let allMinorStops = [];
    
    if (localData.minor_stop && localData.minor_stop.length > 0) {
      const masterStops = localData.minor_stop.map(m => ({ 
        id: m.id, 
        nama: m.nama, 
        durasi: 0, 
        isCustom: false 
      }));
      allMinorStops = [...allMinorStops, ...masterStops];
    }
    
    if (oeeFormState.minorStop && oeeFormState.minorStop.length > 0) {
      const customStops = oeeFormState.minorStop.filter(ms => ms.isCustom);
      allMinorStops = [...allMinorStops, ...customStops];
    }
    
    const uniqueStops = [];
    const ids = new Set();
    allMinorStops.forEach(ms => {
      if (!ids.has(ms.id)) {
        ids.add(ms.id);
        uniqueStops.push(ms);
      }
    });
    
    oeeFormState.minorStop = uniqueStops;

    if (oeeFormState.minorStop.length === 0) {
      listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-text">BELUM ADA DATA MINOR STOP</div></div>';
      return;
    }

    listDiv.innerHTML = oeeFormState.minorStop.map(ms => `
      <div class="ms-row">
        <div>
          <p style="font-size: 13px; font-weight: 700; color: #d97706; margin: 0;">${ms.nama}</p>
        </div>
        <input type="number" class="input-field" value="${ms.durasi}" min="0" placeholder="ACTUAL TIME" onchange="updateMinorStop('${ms.id}', 'durasi', this.value)">
        ${ms.isCustom ? `<button type="button" class="btn btn-danger btn-small" style="padding: 8px;" onclick="removeMinorStop('${ms.id}')">HAPUS</button>` : ''}
      </div>
    `).join('');
  }

  function updateMinorStop(id, field, value) {
    const ms = oeeFormState.minorStop.find(m => m.id === id);
    if (ms) {
      ms[field] = value;
    }
    calculateOEE();
  }

  function removeMinorStop(id) {
    oeeFormState.minorStop = oeeFormState.minorStop.filter(m => m.id !== id);
    renderMinorStopList();
    calculateOEE();
  }

  // ==================== CALCULATE OEE ====================
  function calculateOEE() {
    let totalOutput = 0, totalReject = 0;
    
    let totalMaxDuration = 0;
    oeeFormState.packerMeters.forEach(meter => {
      let maxDurInMeter = 0;
      meter.packers.forEach(p => {
        maxDurInMeter = Math.max(maxDurInMeter, p.duration || 0);
        totalOutput += p.output || 0;
        totalReject += p.reject || 0;
      });
      totalMaxDuration += maxDurInMeter;
    });
    
    const totalODT = oeeFormState.downtime.reduce((s, o) => s + ((parseFloat(o.frekuensi) || 1) * (parseFloat(o.durasi) || 0)), 0);
    const totalLSM = oeeFormState.lineStopMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    const totalLSNM = oeeFormState.lineStopNonMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    const totalMinor = oeeFormState.minorStop.reduce((s, m) => s + (parseFloat(m.durasi) || 0), 0);
    const totalActualDowntime = totalLSM + totalLSNM + totalMinor;
    
    const plannedTime = oeeFormState.shiftMinutes - totalODT;
    const availableTime = plannedTime - totalActualDowntime;
    
    let availActual = plannedTime > 0 ? (availableTime / plannedTime) * 100 : 0;
    let avail365 = oeeFormState.shiftMinutes > 0 ? ((oeeFormState.shiftMinutes - totalODT - totalLSM - totalLSNM) / oeeFormState.shiftMinutes) * 100 : 0;
    
    let totalTarget = 0;
    oeeFormState.packerMeters.forEach(meter => {
      const product = localData.produk.find(p => p.id === meter.productId);
      if (product) {
        meter.packers.forEach(p => {
          totalTarget += (p.duration || 0) * product.target;
        });
      }
    });
    
    let performance = totalTarget > 0 ? (totalOutput / totalTarget) * 100 : 0;
    let quality = totalOutput > 0 ? ((totalOutput - totalReject) / totalOutput) * 100 : 0;
    
    let oeeActual = (availActual / 100) * (performance / 100) * (quality / 100) * 100;
    let oee365 = (avail365 / 100) * (performance / 100) * (quality / 100) * 100;
    
    const hasOver100 = availActual > 100 || avail365 > 100 || performance > 100 || quality > 100;
    
    const over100Warning = document.getElementById('oee-over100-warning');
    if (hasOver100) {
      over100Warning.innerHTML = `
        <p class="warning-title">‚ö†Ô∏è PERINGATAN: KOMPONEN OEE > 100%</p>
        <p class="warning-text">TERDAPAT KOMPONEN OEE YANG MELEBIHI 100%. CEK KEMBALI DATA ANDA.</p>
      `;
      over100Warning.style.display = 'block';
    } else {
      over100Warning.style.display = 'none';
    }
    
    document.getElementById('calc-availability-actual').textContent = `${availActual.toFixed(1)}%`;
    document.getElementById('calc-availability-365').textContent = `${avail365.toFixed(1)}%`;
    document.getElementById('calc-performance').textContent = `${performance.toFixed(1)}%`;
    document.getElementById('calc-quality').textContent = `${quality.toFixed(1)}%`;
    document.getElementById('calc-oee-actual').textContent = `${oeeActual.toFixed(1)}%`;
    document.getElementById('calc-oee-365').textContent = `${oee365.toFixed(1)}%`;
    document.getElementById('calc-total-output').textContent = `${totalOutput.toFixed(1)} DUS`;
    
    oeeFormState.results = {
      availabilityActual: availActual.toFixed(1),
      availability365: avail365.toFixed(1),
      performance: performance.toFixed(1),
      qualityRate: quality.toFixed(1),
      oeeActual: oeeActual.toFixed(1),
      oee365: oee365.toFixed(1),
      totalOutput,
      totalReject,
      totalMaxDuration,
      totalODT,
      totalLSM,
      totalLSNM,
      totalMinor,
      hasOver100
    };
    updateAvailabilityWarning();
  }

  function loadOEEFormData() {
    document.getElementById('oee-date').value = new Date().toISOString().split('T')[0];
  }

  // ==================== SUBMIT OEE ====================
  async function submitOEE(event) {
    event.preventDefault();
    const date = document.getElementById('oee-date').value;
    const shift = document.getElementById('oee-shift').value;
    const notes = document.getElementById('oee-notes').value;
    
    if (!date || !shift || oeeFormState.packerMeters.length === 0) {
      showToast('TANGGAL, SHIFT & PACKER METER WAJIB DIISI', 'error');
      return;
    }
    
    if (oeeFormState.packerMeters.find(m => !m.productId || !m.batchNumber || m.packers.length === 0)) {
      showToast('PRODUK, BATCH & MINIMAL 1 PACKER WAJIB DIISI DI SETIAP METER', 'error');
      return;
    }
    
    if (oeeFormState.packerMeters.flatMap(m => m.packers.filter(p => !p.packerName)).length > 0) {
      showToast('SEMUA PACKER HARUS DIPILIH', 'error');
      return;
    }
    
    const invalidWR = oeeFormState.lineStopMesin.find(lsm => (parseFloat(lsm.durasi) || 0) >= 180 && !lsm.wr?.trim());
    if (invalidWR) {
      showToast(`NO WR WAJIB UNTUK: ${invalidWR.nama}`, 'error');
      return;
    }

    if (oeeFormState.results.hasOver100) {
      showToast('TERDAPAT KOMPONEN OEE YANG MELEBIHI 100%. CEK KEMBALI DATA ANDA.', 'error');
      return;
    }

    const totalODT = oeeFormState.downtime.reduce((s, o) => s + ((parseFloat(o.frekuensi) || 1) * (parseFloat(o.durasi) || 0)), 0);
    const totalLSM = oeeFormState.lineStopMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    const totalLSNM = oeeFormState.lineStopNonMesin.reduce((s, l) => s + (parseFloat(l.durasi) || 0), 0);
    
    let totalMaxDuration = 0;
    oeeFormState.packerMeters.forEach(meter => {
      let maxDurInMeter = 0;
      meter.packers.forEach(p => {
        maxDurInMeter = Math.max(maxDurInMeter, p.duration || 0);
      });
      totalMaxDuration += maxDurInMeter;
    });
    
    const totalTime = totalODT + totalLSM + totalLSNM + totalMaxDuration;
    
    if (totalTime > oeeFormState.shiftMinutes && oeeFormState.shiftMinutes > 0) {
      showToast(`‚ö†Ô∏è TOTAL WAKTU (${totalTime.toFixed(0)} MENIT) MELEBIHI DURASI SHIFT (${oeeFormState.shiftMinutes} MENIT)!`, 'error');
      return;
    }

    const allPackerNames = oeeFormState.packerMeters.flatMap(m => m.packers.map(p => p.packerName)).join(', ');
    const produkBatch = oeeFormState.packerMeters.map(m => {
      const prod = localData.produk.find(p => p.id === m.productId);
      return `${prod?.nama}(${m.batchNumber})`;
    }).join(' | ');

    const lsmDetails = oeeFormState.lineStopMesin
      .filter(lsm => parseFloat(lsm.durasi) > 0)
      .map(lsm => ({
        nama: lsm.nama,
        durasi: parseFloat(lsm.durasi),
        action: lsm.action || '',
        wr: lsm.wr || ''
      }));

    const lsnmDetails = oeeFormState.lineStopNonMesin
      .filter(lsnm => parseFloat(lsnm.durasi) > 0)
      .map(lsnm => ({
        nama: lsnm.nama,
        durasi: parseFloat(lsnm.durasi),
        action: lsnm.action || ''
      }));

    const minorStopDetails = oeeFormState.minorStop
      .filter(ms => parseFloat(ms.durasi) > 0)
      .map(ms => ({
        nama: ms.nama,
        durasi: parseFloat(ms.durasi)
      }));

    const odtDetails = oeeFormState.downtime
      .filter(odt => parseFloat(odt.durasi) > 0)
      .map(odt => ({
        nama: odt.nama,
        frekuensi: odt.frekuensi || 1,
        durasiPerKejadian: parseFloat(odt.durasi),
        totalDurasi: (odt.frekuensi || 1) * parseFloat(odt.durasi),
        waktuStandard: odt.waktu_standard
      }));

    const lsmString = lsmDetails.map(l => `${l.nama} (${l.durasi} MIN) - ACTION: ${l.action || '-'} - WR: ${l.wr || '-'}`).join(' | ');
    const lsnmString = lsnmDetails.map(l => `${l.nama} (${l.durasi} MIN) - ACTION: ${l.action || '-'}`).join(' | ');
    const msString = minorStopDetails.map(m => `${m.nama} (${m.durasi} MIN)`).join(' | ');
    const odtString = odtDetails.map(o => `${o.nama}: ${o.frekuensi}x ${o.durasiPerKejadian} MIN (TOTAL: ${o.totalDurasi} MIN)`).join(' | ');

    const record = {
      date,
      shift,
      product: produkBatch,
      packers: allPackerNames,
      output_actual: oeeFormState.results.totalOutput,
      availability_actual: parseFloat(oeeFormState.results.availabilityActual),
      performance: parseFloat(oeeFormState.results.performance),
      quality_rate: parseFloat(oeeFormState.results.qualityRate),
      oee_actual: parseFloat(oeeFormState.results.oeeActual),
      oee_365: parseFloat(oeeFormState.results.oee365),
      line_stop_mesin: lsmString || null,
      line_stop_non_mesin: lsnmString || null,
      minor_stop: msString || null,
      operational_downtime: odtString || null,
      odt_details: odtDetails.length > 0 ? JSON.stringify(odtDetails) : null,
      ms_details: minorStopDetails.length > 0 ? JSON.stringify(minorStopDetails) : null,
      notes: notes || null
    };

    try {
      const { error } = await supabaseClient.from('oee_records').insert([record]);
      if (error) throw error;
      
      const newRecord = { 
        ...record, 
        availability_365: parseFloat(oeeFormState.results.availability365),
        lsm_details: lsmDetails,
        lsnm_details: lsnmDetails,
        ms_details: minorStopDetails,
        odt_details: odtDetails
      };
      
      localData.oee_records.unshift(newRecord);
      
      console.log('‚úÖ Record saved with details:', newRecord);
      
      await addAuditLog('INPUT OEE', `${produkBatch} - PACKER: ${allPackerNames} | ODT: ${odtDetails.length} | LSM: ${lsmDetails.length} | LSNM: ${lsnmDetails.length} | MS: ${minorStopDetails.length} | NOTES: ${notes || '-'}`);
      showToast('DATA OEE BERHASIL DISIMPAN ‚úÖ', 'success');
      resetOEEForm();
      updateDashboard();
    } catch (error) {
      console.error('‚ùå Error saving OEE:', error);
      showToast('GAGAL MENYIMPAN DATA OEE - ' + (error.message || ''), 'error');
    }
  }

  function resetOEEForm() {
    document.getElementById('form-oee').reset();
    document.getElementById('oee-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('oee-notes').value = '';
    oeeFormState = { 
      shiftMinutes: 0, 
      packerMeters: [], 
      downtime: [], 
      lineStopMesin: [], 
      lineStopNonMesin: [], 
      minorStop: [], 
      results: {},
      odtOverRecords: [],
      notes: ''
    };
    document.getElementById('packer-meter-list').innerHTML = '';
    document.getElementById('odt-list').innerHTML = '';
    document.getElementById('line-stop-mesin-list').innerHTML = '';
    document.getElementById('line-stop-non-mesin-list').innerHTML = '';
    document.getElementById('minor-stop-list').innerHTML = '';
    document.getElementById('calc-availability-actual').textContent = '0%';
    document.getElementById('calc-availability-365').textContent = '0%';
    document.getElementById('calc-performance').textContent = '0%';
    document.getElementById('calc-quality').textContent = '0%';
    document.getElementById('calc-oee-actual').textContent = '0%';
    document.getElementById('calc-oee-365').textContent = '0%';
    document.getElementById('calc-total-output').textContent = '0 DUS';
    document.getElementById('availability-warning').style.display = 'none';
    document.getElementById('oee-over100-warning').style.display = 'none';
  }

  // ==================== DASHBOARD ====================
  function initDashboardFilters() {
    populateFilterOptions();
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    document.getElementById('filter-date-start').value = startDate.toISOString().split('T')[0];
    document.getElementById('filter-date-end').value = endDate.toISOString().split('T')[0];
    applyDashboardFilters();
  }

  function populateFilterOptions() {
    const productSelect = document.getElementById('filter-product');
    productSelect.querySelectorAll('option:not(:first-child)').forEach(o => o.remove());
    localData.produk.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.nama;
      productSelect.appendChild(opt);
    });
    
    const packerSelect = document.getElementById('filter-packer');
    packerSelect.querySelectorAll('option:not(:first-child)').forEach(o => o.remove());
    localData.packer.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.nama;
      opt.textContent = p.nama;
      packerSelect.appendChild(opt);
    });
  }

  function applyDashboardFilters() {
    const ds = document.getElementById('filter-date-start').value;
    const de = document.getElementById('filter-date-end').value;
    const shift = document.getElementById('filter-shift').value;
    const sp = document.getElementById('filter-product').value;
    const spk = document.getElementById('filter-packer').value;
    
    filteredOeeRecords = localData.oee_records.filter(r => {
      if (ds && r.date < ds) return false;
      if (de && r.date > de) return false;
      if (shift && r.shift !== shift) return false;
      if (sp && !r.product?.includes(sp)) return false;
      if (spk && !r.packers?.includes(spk)) return false;
      return true;
    });
    updateDashboard();
  }

  function resetDashboardFilters() {
    document.getElementById('filter-date-start').value = '';
    document.getElementById('filter-date-end').value = '';
    document.getElementById('filter-shift').value = '';
    document.getElementById('filter-product').value = '';
    document.getElementById('filter-packer').value = '';
    filteredOeeRecords = [...localData.oee_records];
    updateDashboard();
  }

  function updateDashboard() {
    updateDashboardData();
    renderCharts();
    renderPackerPerformance();
    renderOEEHistory();
    renderLSMDetailTable();
    renderLSNMDetailTable();
  }

  function updateDashboardData() {
    const recs = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    if (!recs || !recs.length) {
      document.getElementById('score-oee-actual').textContent = '0%';
      document.getElementById('score-oee-365').textContent = '0%';
      document.getElementById('score-total-output').textContent = '0';
      return;
    }
    let sActual = 0, cActual = 0, s365 = 0, c365 = 0, tOut = 0;
    recs.forEach(r => {
      const a = parseFloat(r.oee_actual) || 0;
      const b = parseFloat(r.oee_365) || 0;
      const o = parseFloat(r.output_actual) || 0;
      if (a > 0) { sActual += a; cActual++; }
      if (b > 0) { s365 += b; c365++; }
      tOut += o;
    });
    document.getElementById('score-oee-actual').textContent = `${(cActual ? sActual / cActual : 0).toFixed(1)}%`;
    document.getElementById('score-oee-365').textContent = `${(c365 ? s365 / c365 : 0).toFixed(1)}%`;
    document.getElementById('score-total-output').textContent = tOut.toLocaleString('id-ID');
  }

  // ==================== CHART FUNCTIONS ====================
  function createBarChartWithLabels(canvasId, labels, data, label, backgroundColor) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (dashboardCharts[canvasId]) dashboardCharts[canvasId].destroy();
    
    dashboardCharts[canvasId] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          backgroundColor: backgroundColor,
          borderRadius: 8,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { 
            enabled: true,
            callbacks: {
              label: function(context) {
                return `${context.raw} MENIT`;
              }
            }
          }
        },
        scales: {
          x: { 
            beginAtZero: true,
            grid: { display: true },
            ticks: {
              callback: function(value) {
                return value;
              }
            }
          },
          y: { 
            grid: { display: false },
            ticks: {
              font: { size: 11, weight: 'bold' },
              callback: function(val) {
                const label = this.getLabelForValue(val);
                return label.length > 25 ? label.substr(0, 23) + '...' : label;
              }
            }
          }
        },
        layout: {
          padding: { right: 60 }
        }
      },
      plugins: [{
        id: 'valueLabels',
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          ctx.save();
          
          chart.data.datasets.forEach((dataset, datasetIndex) => {
            const meta = chart.getDatasetMeta(datasetIndex);
            
            meta.data.forEach((element, index) => {
              const value = dataset.data[index];
              if (value === 0) return;
              
              const barX = element.x;
              const barY = element.y;
              
              ctx.font = 'bold 11px "Segoe UI", "Trebuchet MS", sans-serif';
              ctx.textAlign = 'left';
              ctx.textBaseline = 'middle';
              
              const valueText = value.toFixed(0);
              const textX = barX + 8;
              const textY = barY;
              
              ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
              const textWidth = ctx.measureText(valueText).width;
              ctx.fillRect(textX - 4, textY - 10, textWidth + 8, 20);
              
              ctx.fillStyle = '#000000';
              ctx.fillText(valueText, textX, textY);
            });
          });
          
          ctx.restore();
        }
      }]
    });
  }

  function createLineChart(canvasId, labels, data, label, borderColor, backgroundColor) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (dashboardCharts[canvasId]) dashboardCharts[canvasId].destroy();
    
    dashboardCharts[canvasId] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          borderColor: borderColor,
          backgroundColor: backgroundColor,
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointBackgroundColor: borderColor
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          y: { 
            beginAtZero: true, 
            max: 100, 
            ticks: { callback: v => v + '%' },
            grid: { display: true }
          },
          x: { 
            grid: { display: false },
            ticks: { maxRotation: 45, minRotation: 30 }
          }
        }
      }
    });
  }

  // ==================== DOWNTIME CHARTS ====================
  function renderODTTop10Chart() {
    const downtimeMap = {};
    
    const records = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    records.forEach(record => {
      if (record.odt_details) {
        try {
          const odtDetails = typeof record.odt_details === 'string' ? JSON.parse(record.odt_details) : record.odt_details;
          if (Array.isArray(odtDetails)) {
            odtDetails.forEach(odt => {
              if (!downtimeMap[odt.nama]) downtimeMap[odt.nama] = 0;
              downtimeMap[odt.nama] += odt.totalDurasi || 0;
            });
          }
        } catch (e) {
          console.log('Error parsing odt_details:', e);
        }
      } 
      else if (record.operational_downtime) {
        const matches = record.operational_downtime.match(/([^:]+):\s*(\d+)x\s*(\d+)\s*MIN\s*\(TOTAL:\s*(\d+)\s*MIN\)/g);
        if (matches) {
          matches.forEach(match => {
            const nameMatch = match.match(/([^:]+):\s*(\d+)x\s*(\d+)\s*MIN\s*\(TOTAL:\s*(\d+)\s*MIN\)/);
            if (nameMatch) {
              const nama = nameMatch[1].trim();
              const totalDurasi = parseInt(nameMatch[4]) || 0;
              if (!downtimeMap[nama]) downtimeMap[nama] = 0;
              downtimeMap[nama] += totalDurasi;
            }
          });
        }
      }
    });

    const sortedData = Object.entries(downtimeMap)
      .map(([nama, durasi]) => ({ nama, durasi }))
      .sort((a, b) => b.durasi - a.durasi)
      .slice(0, 10);

    if (sortedData.length === 0) {
      createBarChartWithLabels('chart-odt-top10', ['TIDAK ADA DATA'], [0], 'MENIT', '#3b82f6');
      return;
    }

    createBarChartWithLabels(
      'chart-odt-top10',
      sortedData.map(d => d.nama),
      sortedData.map(d => d.durasi),
      'MENIT',
      '#3b82f6'
    );
  }

  function renderLineStopMesinTop10Chart() {
    const lsmMap = {};
    
    const records = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    records.forEach(record => {
      if (record.lsm_details && Array.isArray(record.lsm_details)) {
        record.lsm_details.forEach(lsm => {
          if (!lsmMap[lsm.nama]) lsmMap[lsm.nama] = 0;
          lsmMap[lsm.nama] += lsm.durasi || 0;
        });
      } else if (record.line_stop_mesin) {
        const matches = record.line_stop_mesin.match(/([^(]+)\s*\((\d+)\s*MIN\)/g);
        if (matches) {
          matches.forEach(match => {
            const nameMatch = match.match(/([^(]+)\s*\((\d+)\s*MIN\)/);
            if (nameMatch) {
              const nama = nameMatch[1].trim();
              const durasi = parseInt(nameMatch[2]) || 0;
              if (!lsmMap[nama]) lsmMap[nama] = 0;
              lsmMap[nama] += durasi;
            }
          });
        }
      }
    });

    const sortedData = Object.entries(lsmMap)
      .map(([nama, durasi]) => ({ nama, durasi }))
      .sort((a, b) => b.durasi - a.durasi)
      .slice(0, 10);

    if (sortedData.length === 0) {
      createBarChartWithLabels('chart-lsm-top10', ['TIDAK ADA DATA'], [0], 'MENIT', '#8b5cf6');
      return;
    }

    createBarChartWithLabels(
      'chart-lsm-top10',
      sortedData.map(d => d.nama),
      sortedData.map(d => d.durasi),
      'MENIT',
      '#8b5cf6'
    );
  }

  function renderLineStopNonMesinTop10Chart() {
    const lsnmMap = {};
    
    const records = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    records.forEach(record => {
      if (record.lsnm_details && Array.isArray(record.lsnm_details)) {
        record.lsnm_details.forEach(lsnm => {
          if (!lsnmMap[lsnm.nama]) lsnmMap[lsnm.nama] = 0;
          lsnmMap[lsnm.nama] += lsnm.durasi || 0;
        });
      } else if (record.line_stop_non_mesin) {
        const matches = record.line_stop_non_mesin.match(/([^(]+)\s*\((\d+)\s*MIN\)/g);
        if (matches) {
          matches.forEach(match => {
            const nameMatch = match.match(/([^(]+)\s*\((\d+)\s*MIN\)/);
            if (nameMatch) {
              const nama = nameMatch[1].trim();
              const durasi = parseInt(nameMatch[2]) || 0;
              if (!lsnmMap[nama]) lsnmMap[nama] = 0;
              lsnmMap[nama] += durasi;
            }
          });
        }
      }
    });

    const sortedData = Object.entries(lsnmMap)
      .map(([nama, durasi]) => ({ nama, durasi }))
      .sort((a, b) => b.durasi - a.durasi)
      .slice(0, 10);

    if (sortedData.length === 0) {
      createBarChartWithLabels('chart-lsnm-top10', ['TIDAK ADA DATA'], [0], 'MENIT', '#10b981');
      return;
    }

    createBarChartWithLabels(
      'chart-lsnm-top10',
      sortedData.map(d => d.nama),
      sortedData.map(d => d.durasi),
      'MENIT',
      '#10b981'
    );
  }

  function renderMinorStopTop10Chart() {
    const msMap = {};
    
    const records = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    
    records.forEach(record => {
      if (record.ms_details) {
        try {
          const msDetails = typeof record.ms_details === 'string' ? JSON.parse(record.ms_details) : record.ms_details;
          if (Array.isArray(msDetails)) {
            msDetails.forEach(ms => {
              if (!msMap[ms.nama]) msMap[ms.nama] = 0;
              msMap[ms.nama] += ms.durasi || 0;
            });
          }
        } catch (e) {
          console.log('Error parsing ms_details:', e);
        }
      }
      else if (record.minor_stop) {
        const matches = record.minor_stop.match(/([^(]+)\s*\((\d+)\s*MIN\)/g);
        if (matches) {
          matches.forEach(match => {
            const nameMatch = match.match(/([^(]+)\s*\((\d+)\s*MIN\)/);
            if (nameMatch) {
              const nama = nameMatch[1].trim();
              const durasi = parseInt(nameMatch[2]) || 0;
              if (!msMap[nama]) msMap[nama] = 0;
              msMap[nama] += durasi;
            }
          });
        }
      }
    });

    const sortedData = Object.entries(msMap)
      .map(([nama, durasi]) => ({ nama, durasi }))
      .sort((a, b) => b.durasi - a.durasi)
      .slice(0, 10);

    if (sortedData.length === 0) {
      createBarChartWithLabels('chart-ms-top10', ['TIDAK ADA DATA'], [0], 'MENIT', '#f59e0b');
      return;
    }

    createBarChartWithLabels(
      'chart-ms-top10',
      sortedData.map(d => d.nama),
      sortedData.map(d => d.durasi),
      'MENIT',
      '#f59e0b'
    );
  }

  function renderOEEMonthlyChart() {
    const monthly = {};
    for (let m = 1; m <= 12; m++) monthly[`2026-${String(m).padStart(2,'0')}`] = [];
    const recs = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    recs.forEach(r => { 
      if (monthly[r.date?.substring(0,7)]) { 
        const v = parseFloat(r.oee_actual) || 0; 
        if (v > 0) monthly[r.date.substring(0,7)].push(v); 
      } 
    });
    const labels = Object.keys(monthly).map(ym => { 
      const [y,m] = ym.split('-'); 
      return new Date(y,m-1).toLocaleDateString('id-ID',{month:'short',year:'2-digit'}); 
    });
    const data = Object.values(monthly).map(arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0);
    
    createLineChart(
      'chart-oee-monthly',
      labels,
      data,
      'OEE ACTUAL %',
      '#ec4899',
      'rgba(236,72,153,0.1)'
    );
  }

  function renderOEEDailyChart() {
    const daily = {};
    const today = new Date(), year = today.getFullYear(), month = today.getMonth(), last = new Date(year, month + 1, 0).getDate();
    for (let d = 1; d <= last; d++) daily[`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`] = [];
    const recs = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    recs.forEach(r => { 
      if (daily[r.date]) { 
        const v = parseFloat(r.oee_actual) || 0; 
        if (v > 0) daily[r.date].push(v); 
      } 
    });
    const labels = Object.keys(daily).map(d => new Date(d+'T00:00:00').toLocaleDateString('id-ID',{day:'2-digit',month:'short'}));
    const data = Object.values(daily).map(arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0);
    
    createLineChart(
      'chart-oee-daily',
      labels,
      data,
      'OEE ACTUAL %',
      '#a855f7',
      'rgba(168,85,247,0.1)'
    );
  }

  function renderAPQABreakdownChart() {
    const recs = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    if (!recs || !recs.length) return;
    
    let sAA = 0, cAA = 0, sA365 = 0, cA365 = 0, sPerf = 0, cPerf = 0, sQual = 0, cQual = 0;
    recs.forEach(r => {
      const aa = parseFloat(r.availability_actual) || 0;
      const perf = parseFloat(r.performance) || 0;
      const qual = parseFloat(r.quality_rate) || 0;
      if (aa > 0) { sAA += aa; cAA++; }
      if (perf > 0) { sPerf += perf; cPerf++; }
      if (qual > 0) { sQual += qual; cQual++; }
      const a365 = parseFloat(r.availability_365) || 85;
      sA365 += a365; cA365++;
    });

    const ctx = document.getElementById('chart-apqa-breakdown').getContext('2d');
    if (dashboardCharts['chart-apqa-breakdown']) dashboardCharts['chart-apqa-breakdown'].destroy();
    
    dashboardCharts['chart-apqa-breakdown'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['AVAILABILITY ACTUAL', 'AVAILABILITY 365', 'PERFORMANCE', 'QUALITY RATE'],
        datasets: [{
          label: '%',
          data: [
            cAA ? sAA / cAA : 0, 
            cA365 ? sA365 / cA365 : 0, 
            cPerf ? sPerf / cPerf : 0, 
            cQual ? sQual / cQual : 0
          ],
          backgroundColor: ['#3b82f6', '#60a5fa', '#8b5cf6', '#10b981'],
          borderRadius: 8,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: { 
            beginAtZero: true, 
            max: 100, 
            ticks: { callback: v => v + '%' },
            grid: { display: true }
          },
          y: { 
            grid: { display: false },
            ticks: { font: { size: 11, weight: 'bold' } }
          }
        },
        layout: {
          padding: { right: 60 }
        }
      },
      plugins: [{
        id: 'valueLabels',
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          ctx.save();
          
          chart.data.datasets.forEach((dataset, datasetIndex) => {
            const meta = chart.getDatasetMeta(datasetIndex);
            
            meta.data.forEach((element, index) => {
              const value = dataset.data[index];
              if (value === 0) return;
              
              const barX = element.x;
              const barY = element.y;
              
              ctx.font = 'bold 11px "Segoe UI", "Trebuchet MS", sans-serif';
              ctx.textAlign = 'left';
              ctx.textBaseline = 'middle';
              
              const valueText = value.toFixed(1) + '%';
              const textX = barX + 8;
              const textY = barY;
              
              ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
              const textWidth = ctx.measureText(valueText).width;
              ctx.fillRect(textX - 4, textY - 10, textWidth + 8, 20);
              
              ctx.fillStyle = '#000000';
              ctx.fillText(valueText, textX, textY);
            });
          });
          
          ctx.restore();
        }
      }]
    });
  }

  function renderCharts() {
    renderOEEMonthlyChart();
    renderOEEDailyChart();
    renderAPQABreakdownChart();
    renderODTTop10Chart();
    renderLineStopMesinTop10Chart();
    renderLineStopNonMesinTop10Chart();
    renderMinorStopTop10Chart();
  }

  // ==================== RENDER PACKER PERFORMANCE ====================
  function renderPackerPerformance() {
    const map = {};
    const recs = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    
    recs.forEach(r => {
      const packerNames = r.packers?.split(', ') || [];
      packerNames.forEach(p => {
        if (!p) return;
        if (!map[p]) {
          map[p] = { 
            nama: p, 
            oeeValues: [], 
            targetOutput: 0,
            outputActual: 0,
            records: 0
          };
        }
        const oee = parseFloat(r.oee_actual) || 0;
        if (oee > 0) map[p].oeeValues.push(oee);
        
        const performance = parseFloat(r.performance) || 0;
        const outputActual = parseFloat(r.output_actual) || 0;
        
        if (performance > 0 && outputActual > 0) {
          const targetPerRecord = (outputActual * 100) / performance;
          const targetPerPacker = targetPerRecord / packerNames.length;
          map[p].targetOutput += targetPerPacker;
        }
        
        const outputPerPacker = outputActual / packerNames.length;
        map[p].outputActual += outputPerPacker;
        map[p].records++;
      });
    });
    
    const data = Object.values(map).sort((a,b) => {
      const aa = a.oeeValues.length ? a.oeeValues.reduce((x,y)=>x+y,0)/a.oeeValues.length : 0;
      const bb = b.oeeValues.length ? b.oeeValues.reduce((x,y)=>x+y,0)/b.oeeValues.length : 0;
      return bb - aa;
    });
    
    const tbody = document.getElementById('table-packer-performance');
    if (!data.length) { 
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-8">BELUM ADA DATA</td></tr>'; 
      return; 
    }
    
    tbody.innerHTML = data.map((p,i) => {
      const avgOee = p.oeeValues.length ? p.oeeValues.reduce((a,b)=>a+b,0)/p.oeeValues.length : 0;
      return `<tr>
        <td>${i+1}</td>
        <td>${p.nama}</td>
        <td>${avgOee.toFixed(1)}%</td>
        <td>${p.targetOutput.toLocaleString('id-ID', {maximumFractionDigits:1})}</td>
        <td>${p.outputActual.toLocaleString('id-ID', {maximumFractionDigits:1})}</td>
        <td>${p.records}</td>
      </tr>`;
    }).join('');
  }

  // ==================== RENDER OEE HISTORY ====================
  function renderOEEHistory() {
    const tbody = document.getElementById('table-oee-history');
    const recs = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    if (!recs || !recs.length) { 
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-400 py-8">BELUM ADA DATA</td></tr>'; 
      return; 
    }
    tbody.innerHTML = recs.slice(0,50).map(r => `
      <tr>
        <td style="white-space: normal; word-break: break-word;">${r.date || '-'}</td>
        <td style="white-space: normal; word-break: break-word;">${r.shift || '-'}</td>
        <td style="white-space: normal; word-break: break-word;">${r.packers || '-'}</td>
        <td style="white-space: normal; word-break: break-word;">${r.product || '-'}</td>
        <td style="white-space: normal; word-break: break-word;"><strong>${(parseFloat(r.oee_actual)||0).toFixed(1)}%</strong></td>
        <td style="white-space: normal; word-break: break-word;">${(parseFloat(r.oee_365)||0).toFixed(1)}%</td>
        <td style="white-space: normal; word-break: break-word;">${r.notes || '-'}</td>
      </tr>
    `).join('');
  }

  // ==================== RENDER LSM DETAIL TABLE ====================
  function renderLSMDetailTable() {
    const tbody = document.getElementById('table-lsm-detail');
    const recs = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    if (!recs || !recs.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-400 py-8">BELUM ADA DATA</td></tr>';
      return;
    }
    
    const rows = [];
    recs.slice(0,100).forEach(record => {
      if (record.lsm_details && Array.isArray(record.lsm_details) && record.lsm_details.length > 0) {
        record.lsm_details.forEach(lsm => {
          rows.push({
            date: record.date,
            shift: record.shift,
            packers: record.packers,
            nama: lsm.nama,
            durasi: lsm.durasi,
            wr: lsm.wr || '-',
            action: lsm.action || '-'
          });
        });
      } else if (record.line_stop_mesin) {
        const matches = record.line_stop_mesin.match(/([^(]+)\s*\((\d+)\s*MIN\)\s*-\s*ACTION:\s*([^-]+)?\s*-\s*WR:\s*(.+)?/);
        if (matches) {
          rows.push({
            date: record.date,
            shift: record.shift,
            packers: record.packers,
            nama: matches[1].trim(),
            durasi: parseInt(matches[2]) || 0,
            wr: matches[4]?.trim() || '-',
            action: matches[3]?.trim() || '-'
          });
        }
      }
    });
    
    if (rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-400 py-8">BELUM ADA DATA LINE STOP MESIN</td></tr>';
      return;
    }
    
    tbody.innerHTML = rows.map(row => `
      <tr>
        <td>${row.date}</td>
        <td>${row.shift}</td>
        <td>${row.packers || '-'}</td>
        <td>${row.nama}</td>
        <td>${row.durasi}</td>
        <td>${row.wr}</td>
        <td>${row.action}</td>
      </tr>
    `).join('');
  }

  // ==================== RENDER LSNM DETAIL TABLE ====================
  function renderLSNMDetailTable() {
    const tbody = document.getElementById('table-lsnm-detail');
    const recs = filteredOeeRecords.length ? filteredOeeRecords : localData.oee_records;
    if (!recs || !recs.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-8">BELUM ADA DATA</td></tr>';
      return;
    }
    
    const rows = [];
    recs.slice(0,100).forEach(record => {
      if (record.lsnm_details && Array.isArray(record.lsnm_details) && record.lsnm_details.length > 0) {
        record.lsnm_details.forEach(lsnm => {
          rows.push({
            date: record.date,
            shift: record.shift,
            packers: record.packers,
            nama: lsnm.nama,
            durasi: lsnm.durasi,
            action: lsnm.action || '-'
          });
        });
      } else if (record.line_stop_non_mesin) {
        const matches = record.line_stop_non_mesin.match(/([^(]+)\s*\((\d+)\s*MIN\)\s*-\s*ACTION:\s*(.+)?/);
        if (matches) {
          rows.push({
            date: record.date,
            shift: record.shift,
            packers: record.packers,
            nama: matches[1].trim(),
            durasi: parseInt(matches[2]) || 0,
            action: matches[3]?.trim() || '-'
          });
        }
      }
    });
    
    if (rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-8">BELUM ADA DATA LINE STOP NON-MESIN</td></tr>';
      return;
    }
    
    tbody.innerHTML = rows.map(row => `
      <tr>
        <td>${row.date}</td>
        <td>${row.shift}</td>
        <td>${row.packers || '-'}</td>
        <td>${row.nama}</td>
        <td>${row.durasi}</td>
        <td>${row.action}</td>
      </tr>
    `).join('');
  }

  // ==================== MASTER DATA RENDER ====================
  function renderMasterDataLists() {
    renderProductList();
    renderPackerList();
    renderODTList_Master();
    renderLineStopMesinMaster();
    renderLineStopNonMesinMaster();
    renderMinorStopMaster();
  }

  function renderProductList() {
    document.getElementById('product-list').innerHTML = localData.produk.map(p => `
      <div class="master-card" id="card-prod-${p.id}">
        <div class="master-card-content">
          <p class="master-card-name">${p.nama}</p>
          <p class="master-card-detail">TARGET: ${p.target} DUS/MENIT</p>
        </div>
        <div class="master-card-actions">
          <button class="btn-edit" onclick="editProduct('${p.id}')">EDIT</button>
          <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'produk', '${p.nama}')">HAPUS</button>
        </div>
      </div>
    `).join('');
  }

  function renderPackerList() {
    document.getElementById('packer-list').innerHTML = localData.packer.map(p => `
      <div class="master-card" id="card-pack-${p.id}">
        <div class="master-card-content"><p class="master-card-name">${p.nama}</p></div>
        <div class="master-card-actions">
          <button class="btn-edit" onclick="editPacker('${p.id}')">EDIT</button>
          <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'packer', '${p.nama}')">HAPUS</button>
        </div>
      </div>
    `).join('');
  }

  function renderODTList_Master() {
    document.getElementById('odt-master-list').innerHTML = localData.downtime.map(p => `
      <div class="master-card" id="card-odt-${p.id}">
        <div class="master-card-content">
          <p class="master-card-name">${p.nama}</p>
          <p class="master-card-detail">STD: ${p.waktu_standard} MENIT</p>
        </div>
        <div class="master-card-actions">
          <button class="btn-edit" onclick="editODT('${p.id}')">EDIT</button>
          <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'odt', '${p.nama}')">HAPUS</button>
        </div>
      </div>
    `).join('');
  }

  function renderLineStopMesinMaster() {
    document.getElementById('line-stop-mesin-master-list').innerHTML = localData.line_stop_mesin.map(p => `
      <div class="master-card" id="card-lsm-${p.id}">
        <div class="master-card-content"><p class="master-card-name">${p.nama}</p></div>
        <div class="master-card-actions">
          <button class="btn-edit" onclick="editLineStopMesin('${p.id}')">EDIT</button>
          <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'lsm', '${p.nama}')">HAPUS</button>
        </div>
      </div>
    `).join('');
  }

  function renderLineStopNonMesinMaster() {
    document.getElementById('line-stop-non-mesin-master-list').innerHTML = localData.line_stop_non_mesin.map(p => `
      <div class="master-card" id="card-lsnm-${p.id}">
        <div class="master-card-content"><p class="master-card-name">${p.nama}</p></div>
        <div class="master-card-actions">
          <button class="btn-edit" onclick="editLineStopNonMesin('${p.id}')">EDIT</button>
          <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'lsnm', '${p.nama}')">HAPUS</button>
        </div>
      </div>
    `).join('');
  }

  function renderMinorStopMaster() {
    document.getElementById('minor-stop-master-list').innerHTML = localData.minor_stop.map(p => `
      <div class="master-card" id="card-ms-${p.id}">
        <div class="master-card-content"><p class="master-card-name">${p.nama}</p></div>
        <div class="master-card-actions">
          <button class="btn-edit" onclick="editMinorStop('${p.id}')">EDIT</button>
          <button class="btn-delete" onclick="showDeleteConfirm('${p.id}', 'minor_stop', '${p.nama}')">HAPUS</button>
        </div>
      </div>
    `).join('');
  }

  // ==================== MODAL MANAGEMENT ====================
  let currentModalAction = null, currentEditId = null;

  function openModal(title, fields, onSubmit) {
    if (title.includes('PRODUK') || title.includes('PACKER') || title.includes('ODT') || title.includes('LINE STOP') || title.includes('MINOR STOP')) {
      if (!checkMasterAccess()) return;
    }
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-fields').innerHTML = fields.map(f => `
      <div class="form-group" style="margin-bottom: 16px;">
        <label>${f.label}</label>
        <input type="text" id="modal-field-${f.name}" class="input-field" placeholder="${f.placeholder}" value="${f.value || ''}">
      </div>
    `).join('');
    currentModalAction = onSubmit;
    document.getElementById('modal-backdrop').style.display = 'block';
    document.getElementById('modal').style.display = 'block';
    document.getElementById(`modal-field-${fields[0].name}`).focus();
  }

  function closeModal() {
    document.getElementById('modal-backdrop').style.display = 'none';
    document.getElementById('modal').style.display = 'none';
    currentModalAction = null; 
    currentEditId = null;
  }

  function submitModalForm(e) {
    e.preventDefault();
    if (currentModalAction) {
      const vals = {};
      document.querySelectorAll('#modal-fields input').forEach(i => vals[i.id.replace('modal-field-','')] = i.value);
      currentModalAction(vals);
      closeModal();
    }
  }

  // ==================== MASTER DATA CRUD ====================
  function openAddProductModal() {
    openModal('TAMBAH PRODUK', [
      { name: 'nama', label: 'NAMA PRODUK', placeholder: 'MASUKKAN NAMA PRODUK', value: '' },
      { name: 'target', label: 'TARGET (DUS/MENIT)', placeholder: 'MASUKKAN TARGET', value: '' }
    ], async v => {
      if (!v.nama.trim() || !v.target.trim()) { showToast('SEMUA FIELD WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('produk').insert([{ nama: v.nama.trim(), target: parseFloat(v.target) || 0 }]);
        await loadDataFromSupabase();
        renderProductList();
        await addAuditLog('CREATE PRODUCT', v.nama);
        showToast('PRODUK BERHASIL DITAMBAHKAN ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MENAMBAHKAN PRODUK', 'error'); }
    });
  }

  function editProduct(id) {
    const prod = localData.produk.find(p => p.id === id);
    if (!prod) return;
    currentEditId = id;
    openModal('EDIT PRODUK', [
      { name: 'nama', label: 'NAMA PRODUK', placeholder: 'MASUKKAN NAMA PRODUK', value: prod.nama },
      { name: 'target', label: 'TARGET (DUS/MENIT)', placeholder: 'MASUKKAN TARGET', value: prod.target }
    ], async v => {
      if (!v.nama.trim() || !v.target.trim()) { showToast('SEMUA FIELD WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('produk').update({ nama: v.nama.trim(), target: parseFloat(v.target) || 0 }).eq('id', currentEditId);
        await loadDataFromSupabase();
        renderProductList();
        await addAuditLog('UPDATE PRODUCT', v.nama);
        showToast('PRODUK BERHASIL DIPERBARUI ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MEMPERBARUI PRODUK', 'error'); }
    });
  }

  function openAddPackerModal() {
    openModal('TAMBAH PACKER', [{ name: 'nama', label: 'NAMA PACKER', placeholder: 'MASUKKAN NAMA PACKER', value: '' }], async v => {
      if (!v.nama.trim()) { showToast('NAMA PACKER WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('packer').insert([{ nama: v.nama.trim() }]);
        await loadDataFromSupabase();
        renderPackerList();
        await addAuditLog('CREATE PACKER', v.nama);
        showToast('PACKER BERHASIL DITAMBAHKAN ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MENAMBAHKAN PACKER', 'error'); }
    });
  }

  function editPacker(id) {
    const pack = localData.packer.find(p => p.id === id);
    if (!pack) return;
    currentEditId = id;
    openModal('EDIT PACKER', [{ name: 'nama', label: 'NAMA PACKER', placeholder: 'MASUKKAN NAMA PACKER', value: pack.nama }], async v => {
      if (!v.nama.trim()) { showToast('NAMA PACKER WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('packer').update({ nama: v.nama.trim() }).eq('id', currentEditId);
        await loadDataFromSupabase();
        renderPackerList();
        await addAuditLog('UPDATE PACKER', v.nama);
        showToast('PACKER BERHASIL DIPERBARUI ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MEMPERBARUI PACKER', 'error'); }
    });
  }

  function openAddODTModal() {
    openModal('TAMBAH ODT', [
      { name: 'nama', label: 'NAMA ODT', placeholder: 'MASUKKAN NAMA ODT', value: '' },
      { name: 'waktu_standard', label: 'WAKTU STANDARD (MENIT)', placeholder: 'MASUKKAN WAKTU STANDARD', value: '' }
    ], async v => {
      if (!v.nama.trim() || !v.waktu_standard.trim()) { showToast('SEMUA FIELD WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('downtime').insert([{ nama: v.nama.trim(), waktu_standard: parseFloat(v.waktu_standard) || 0 }]);
        await loadDataFromSupabase();
        renderODTList_Master();
        await addAuditLog('CREATE ODT', v.nama);
        showToast('ODT BERHASIL DITAMBAHKAN ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MENAMBAHKAN ODT', 'error'); }
    });
  }

  function editODT(id) {
    const odt = localData.downtime.find(p => p.id === id);
    if (!odt) return;
    currentEditId = id;
    openModal('EDIT ODT', [
      { name: 'nama', label: 'NAMA ODT', placeholder: 'MASUKKAN NAMA ODT', value: odt.nama },
      { name: 'waktu_standard', label: 'WAKTU STANDARD (MENIT)', placeholder: 'MASUKKAN WAKTU STANDARD', value: odt.waktu_standard }
    ], async v => {
      if (!v.nama.trim() || !v.waktu_standard.trim()) { showToast('SEMUA FIELD WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('downtime').update({ nama: v.nama.trim(), waktu_standard: parseFloat(v.waktu_standard) || 0 }).eq('id', currentEditId);
        await loadDataFromSupabase();
        renderODTList_Master();
        await addAuditLog('UPDATE ODT', v.nama);
        showToast('ODT BERHASIL DIPERBARUI ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MEMPERBARUI ODT', 'error'); }
    });
  }

  function openAddLineStopMesinModal() {
    openModal('TAMBAH LINE STOP MESIN', [{ name: 'nama', label: 'NAMA LINE STOP', placeholder: 'MASUKKAN NAMA LINE STOP', value: '' }], async v => {
      if (!v.nama.trim()) { showToast('NAMA LINE STOP WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('line_stop_mesin').insert([{ nama: v.nama.trim() }]);
        await loadDataFromSupabase();
        renderLineStopMesinMaster();
        await addAuditLog('CREATE LINE STOP MESIN', v.nama);
        showToast('LINE STOP MESIN BERHASIL DITAMBAHKAN ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MENAMBAHKAN LINE STOP MESIN', 'error'); }
    });
  }

  function editLineStopMesin(id) {
    const lsm = localData.line_stop_mesin.find(p => p.id === id);
    if (!lsm) return;
    currentEditId = id;
    openModal('EDIT LINE STOP MESIN', [{ name: 'nama', label: 'NAMA LINE STOP', placeholder: 'MASUKKAN NAMA LINE STOP', value: lsm.nama }], async v => {
      if (!v.nama.trim()) { showToast('NAMA LINE STOP WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('line_stop_mesin').update({ nama: v.nama.trim() }).eq('id', currentEditId);
        await loadDataFromSupabase();
        renderLineStopMesinMaster();
        await addAuditLog('UPDATE LINE STOP MESIN', v.nama);
        showToast('LINE STOP MESIN BERHASIL DIPERBARUI ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MEMPERBARUI LINE STOP MESIN', 'error'); }
    });
  }

  function openAddLineStopNonMesinModal() {
    openModal('TAMBAH LINE STOP NON-MESIN', [{ name: 'nama', label: 'NAMA LINE STOP', placeholder: 'MASUKKAN NAMA LINE STOP', value: '' }], async v => {
      if (!v.nama.trim()) { showToast('NAMA LINE STOP WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('line_stop_non_mesin').insert([{ nama: v.nama.trim() }]);
        await loadDataFromSupabase();
        renderLineStopNonMesinMaster();
        await addAuditLog('CREATE LINE STOP NON-MESIN', v.nama);
        showToast('LINE STOP NON-MESIN BERHASIL DITAMBAHKAN ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MENAMBAHKAN LINE STOP NON-MESIN', 'error'); }
    });
  }

  function editLineStopNonMesin(id) {
    const lsnm = localData.line_stop_non_mesin.find(p => p.id === id);
    if (!lsnm) return;
    currentEditId = id;
    openModal('EDIT LINE STOP NON-MESIN', [{ name: 'nama', label: 'NAMA LINE STOP', placeholder: 'MASUKKAN NAMA LINE STOP', value: lsnm.nama }], async v => {
      if (!v.nama.trim()) { showToast('NAMA LINE STOP WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('line_stop_non_mesin').update({ nama: v.nama.trim() }).eq('id', currentEditId);
        await loadDataFromSupabase();
        renderLineStopNonMesinMaster();
        await addAuditLog('UPDATE LINE STOP NON-MESIN', v.nama);
        showToast('LINE STOP NON-MESIN BERHASIL DIPERBARUI ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MEMPERBARUI LINE STOP NON-MESIN', 'error'); }
    });
  }

  function openAddMinorStopModal() {
    openModal('TAMBAH MINOR STOP', [{ name: 'nama', label: 'NAMA MINOR STOP', placeholder: 'MASUKKAN NAMA MINOR STOP', value: '' }], async v => {
      if (!v.nama.trim()) { showToast('NAMA MINOR STOP WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('minor_stop').insert([{ nama: v.nama.trim() }]);
        await loadDataFromSupabase();
        renderMinorStopMaster();
        await addAuditLog('CREATE MINOR STOP', v.nama);
        showToast('MINOR STOP BERHASIL DITAMBAHKAN ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MENAMBAHKAN MINOR STOP', 'error'); }
    });
  }

  function editMinorStop(id) {
    const ms = localData.minor_stop.find(p => p.id === id);
    if (!ms) return;
    currentEditId = id;
    openModal('EDIT MINOR STOP', [{ name: 'nama', label: 'NAMA MINOR STOP', placeholder: 'MASUKKAN NAMA MINOR STOP', value: ms.nama }], async v => {
      if (!v.nama.trim()) { showToast('NAMA MINOR STOP WAJIB DIISI', 'error'); return; }
      try {
        await supabaseClient.from('minor_stop').update({ nama: v.nama.trim() }).eq('id', currentEditId);
        await loadDataFromSupabase();
        renderMinorStopMaster();
        await addAuditLog('UPDATE MINOR STOP', v.nama);
        showToast('MINOR STOP BERHASIL DIPERBARUI ‚úÖ', 'success');
      } catch (e) { showToast('GAGAL MEMPERBARUI MINOR STOP', 'error'); }
    });
  }

  // ==================== DELETE FUNCTIONS ====================
  async function deleteProduct(id) { 
    if (!checkMasterAccess()) return; 
    try { 
      await supabaseClient.from('produk').delete().eq('id',id); 
      await loadDataFromSupabase(); 
      renderProductList(); 
      await addAuditLog('DELETE PRODUCT','PRODUK DIHAPUS'); 
      showToast('PRODUK BERHASIL DIHAPUS','success'); 
    } catch(e){ showToast('GAGAL MENGHAPUS PRODUK','error'); } 
  }
  
  async function deletePacker(id) { 
    if (!checkMasterAccess()) return; 
    try { 
      await supabaseClient.from('packer').delete().eq('id',id); 
      await loadDataFromSupabase(); 
      renderPackerList(); 
      await addAuditLog('DELETE PACKER','PACKER DIHAPUS'); 
      showToast('PACKER BERHASIL DIHAPUS','success'); 
    } catch(e){ showToast('GAGAL MENGHAPUS PACKER','error'); } 
  }
  
  async function deleteODT(id) { 
    if (!checkMasterAccess()) return; 
    try { 
      await supabaseClient.from('downtime').delete().eq('id',id); 
      await loadDataFromSupabase(); 
      renderODTList_Master(); 
      await addAuditLog('DELETE ODT','ODT DIHAPUS'); 
      showToast('ODT BERHASIL DIHAPUS','success'); 
    } catch(e){ showToast('GAGAL MENGHAPUS ODT','error'); } 
  }
  
  async function deleteLineStopMesin(id) { 
    if (!checkMasterAccess()) return; 
    try { 
      await supabaseClient.from('line_stop_mesin').delete().eq('id',id); 
      await loadDataFromSupabase(); 
      renderLineStopMesinMaster(); 
      await addAuditLog('DELETE LINE STOP MESIN','LINE STOP DIHAPUS'); 
      showToast('LINE STOP MESIN BERHASIL DIHAPUS','success'); 
    } catch(e){ showToast('GAGAL MENGHAPUS LINE STOP MESIN','error'); } 
  }
  
  async function deleteLineStopNonMesin(id) { 
    if (!checkMasterAccess()) return; 
    try { 
      await supabaseClient.from('line_stop_non_mesin').delete().eq('id',id); 
      await loadDataFromSupabase(); 
      renderLineStopNonMesinMaster(); 
      await addAuditLog('DELETE LINE STOP NON-MESIN','LINE STOP DIHAPUS'); 
      showToast('LINE STOP NON-MESIN BERHASIL DIHAPUS','success'); 
    } catch(e){ showToast('GAGAL MENGHAPUS LINE STOP NON-MESIN','error'); } 
  }
  
  async function deleteMinorStop(id) { 
    if (!checkMasterAccess()) return; 
    try { 
      await supabaseClient.from('minor_stop').delete().eq('id',id); 
      await loadDataFromSupabase(); 
      renderMinorStopMaster(); 
      await addAuditLog('DELETE MINOR STOP','MINOR STOP DIHAPUS'); 
      showToast('MINOR STOP BERHASIL DIHAPUS','success'); 
    } catch(e){ showToast('GAGAL MENGHAPUS MINOR STOP','error'); } 
  }

  function showDeleteConfirm(id, type, nama) {
    if (!checkMasterAccess()) return;
    const box = document.createElement('div');
    box.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:16px;padding:32px;z-index:10000;box-shadow:0 20px 60px rgba(0,0,0,0.3);min-width:350px;';
    box.innerHTML = `
      <h3 style="margin:0 0 16px;color:#ec4899;font-size:18px;font-weight:700;text-transform:uppercase;">HAPUS DATA?</h3>
      <p style="margin:0 0 24px;color:#6b4c5c;font-size:14px;text-transform:uppercase;">YAKIN INGIN MENGHAPUS <strong>"${nama}"</strong>? TINDAKAN INI TIDAK BISA DIBATALKAN.</p>
      <div style="display:flex;gap:12px;">
        <button class="btn btn-danger" style="flex:1;" onclick="confirmDelete('${id}','${type}'); document.querySelector('[data-confirm-box]').remove();">HAPUS</button>
        <button class="btn btn-secondary" style="flex:1;" onclick="document.querySelector('[data-confirm-box]').remove();">BATAL</button>
      </div>
    `;
    box.setAttribute('data-confirm-box','true');
    const backdrop = document.createElement('div');
    backdrop.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;';
    backdrop.onclick = () => { box.remove(); backdrop.remove(); };
    document.body.appendChild(backdrop);
    document.body.appendChild(box);
  }

  function confirmDelete(id, type) {
    if (type === 'produk') deleteProduct(id);
    else if (type === 'packer') deletePacker(id);
    else if (type === 'odt') deleteODT(id);
    else if (type === 'lsm') deleteLineStopMesin(id);
    else if (type === 'lsnm') deleteLineStopNonMesin(id);
    else if (type === 'minor_stop') deleteMinorStop(id);
  }

  // ==================== AUDIT TRAIL ====================
  function renderAuditTable() {
    const tbody = document.getElementById('audit-table');
    if (localData.audit_trail.length === 0) { 
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-8">BELUM ADA AKTIVITAS</td></tr>'; 
      return; 
    }
    tbody.innerHTML = localData.audit_trail.map(l => `<tr><td>${new Date(l.timestamp).toLocaleString('id-ID')}</td><td>${l.activity}</td><td>${l.detail}</td></tr>`).join('');
  }

  async function addAuditLog(activity, detail) {
    try { 
      await supabaseClient.from('audit_trail').insert([{ activity, detail }]); 
      await loadDataFromSupabase(); 
      renderAuditTable(); 
    } catch(e) { console.error(e); }
  }

  // ==================== TOAST ====================
  function showToast(msg, type) {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }

  // ==================== DARK MODE ====================
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    document.getElementById('mode-icon').textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    document.getElementById('mode-text').textContent = document.body.classList.contains('dark-mode') ? 'LIGHT' : 'DARK';
  }

  function initDarkMode() {
    if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
    document.getElementById('mode-icon').textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    document.getElementById('mode-text').textContent = document.body.classList.contains('dark-mode') ? 'LIGHT' : 'DARK';
  }

  // ==================== CLOCK ====================
  function updateClock() {
    const n = new Date();
    document.getElementById('current-time').textContent = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;
    document.getElementById('current-date').textContent = n.toLocaleDateString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric' }).toUpperCase();
  }

  // ==================== INIT ====================
  initDarkMode();
  updateClock();
  setInterval(updateClock, 1000);
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initApp);
  else initApp();
</script>
</body>
</html>
